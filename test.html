<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯• OCR æµç¨‹</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ§ª OCR æµç¨‹æµ‹è¯•</h1>

    <div class="test-section">
        <h3>æ­¥éª¤1: æµ‹è¯•å›¾ç‰‡ä¸Šä¼ </h3>
        <input type="file" id="testInput" accept="image/*" multiple>
        <button onclick="testUpload()">æµ‹è¯•ä¸Šä¼ </button>
        <div id="uploadResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤2: æµ‹è¯• API Key</h3>
        <input type="password" id="testApiKey" placeholder="è¾“å…¥API Key" style="padding: 8px; width: 300px;">
        <button onclick="testApiKey()">æµ‹è¯•API Key</button>
        <div id="apiKeyResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤3: æµ‹è¯• OCR API</h3>
        <button onclick="testOCRAPI()">æµ‹è¯•åç«¯è¿æ¥</button>
        <div id="ocrApiResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤4: å®Œæ•´æµç¨‹æµ‹è¯•</h3>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="fullTestResult" class="log"></div>
    </div>

    <script>
        let testImages = [];
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            testLog.push(entry);
            console.log(entry);
        }

        function displayLog(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const colorClass = type === 'success' ? 'success' : (type === 'error' ? 'error' : 'info');
            el.innerHTML += `<div class="${colorClass}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testUpload() {
            clearLog('uploadResult');
            testImages = [];

            const input = document.getElementById('testInput');
            if (input.files.length === 0) {
                displayLog('uploadResult', 'âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            log(`å¼€å§‹ä¸Šä¼  ${input.files.length} ä¸ªæ–‡ä»¶`);

            try {
                for (let f of input.files) {
                    displayLog('uploadResult', `ğŸ“ è¯»å–æ–‡ä»¶: ${f.name}`);

                    const result = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(f);
                    });

                    testImages.push({ name: f.name, src: result });
                    displayLog('uploadResult', `âœ… æ–‡ä»¶å·²è¯»å–: ${f.name} (${result.length} å­—ç¬¦)`, 'success');
                }

                displayLog('uploadResult', `<strong>âœ… ä¸Šä¼ å®Œæˆï¼å…± ${testImages.length} ä¸ªæ–‡ä»¶</strong>`, 'success');
                log(`ä¸Šä¼ å®Œæˆï¼ŒtestImages.length = ${testImages.length}`);
            } catch (error) {
                displayLog('uploadResult', `âŒ é”™è¯¯: ${error.message}`, 'error');
                log(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
            }
        }

        function testApiKey() {
            clearLog('apiKeyResult');
            const apiKey = document.getElementById('testApiKey').value.trim();

            if (!apiKey) {
                displayLog('apiKeyResult', 'âŒ API Key ä¸ºç©º', 'error');
                log('API Key ä¸ºç©º');
                return;
            }

            log(`API Key é•¿åº¦: ${apiKey.length}`);
            displayLog('apiKeyResult', `âœ… API Key å·²è¾“å…¥ (é•¿åº¦: ${apiKey.length})`, 'success');
        }

        async function testOCRAPI() {
            clearLog('ocrApiResult');
            displayLog('ocrApiResult', 'ğŸ”„ æµ‹è¯•åç«¯è¿æ¥...');

            log('æµ‹è¯•åç«¯è¿æ¥');

            try {
                const response = await fetch('http://localhost:3001/health');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                displayLog('ocrApiResult', `âœ… åç«¯è¿æ¥æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
                log('åç«¯è¿æ¥æˆåŠŸ');
            } catch (error) {
                displayLog('ocrApiResult', `âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log(`åç«¯è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        async function runFullTest() {
            clearLog('fullTestResult');
            log('=== å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯• ===');

            // 1. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
            displayLog('fullTestResult', '<strong>æ­¥éª¤1: æµ‹è¯•å›¾ç‰‡ä¸Šä¼ </strong>');

            const input = document.getElementById('testInput');
            if (input.files.length === 0) {
                displayLog('fullTestResult', 'âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                log('æµ‹è¯•å¤±è´¥: æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }

            try {
                for (let f of input.files) {
                    displayLog('fullTestResult', `ğŸ“ è¯»å–æ–‡ä»¶: ${f.name}`);

                    const result = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(f);
                    });

                    testImages.push({ name: f.name, src: result });
                    displayLog('fullTestResult', `âœ… æ–‡ä»¶å·²è¯»å–`, 'success');
                }

                log(`ä¸Šä¼ å®Œæˆï¼ŒtestImages.length = ${testImages.length}`);

                // 2. æ£€æŸ¥ API Key
                displayLog('fullTestResult', '<strong>æ­¥éª¤2: æ£€æŸ¥ API Key</strong>');

                const apiKey = document.getElementById('testApiKey').value.trim();
                if (!apiKey) {
                    displayLog('fullTestResult', 'âŒ API Key ä¸ºç©º', 'error');
                    log('æµ‹è¯•å¤±è´¥: API Key ä¸ºç©º');
                    return;
                }

                displayLog('fullTestResult', `âœ… API Key å·²è¾“å…¥ (é•¿åº¦: ${apiKey.length})`, 'success');
                log(`API Key é•¿åº¦: ${apiKey.length}`);

                // 3. æµ‹è¯• OCR API è°ƒç”¨
                displayLog('fullTestResult', '<strong>æ­¥éª¤3: æµ‹è¯• OCR API è°ƒç”¨</strong>');

                const testImg = testImages[0];
                displayLog('fullTestResult', `ğŸ”„ è°ƒç”¨ OCR API: ${testImg.name}`);

                try {
                    const response = await fetch('http://localhost:3001/api/ocr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: testImg.src,
                            apiKey: apiKey
                        })
                    });

                    displayLog('fullTestResult', `ğŸ”„ HTTP çŠ¶æ€: ${response.status}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    displayLog('fullTestResult', `âœ… OCR è°ƒç”¨æˆåŠŸï¼è¿”å›æ•°æ®å¤§å°: ${JSON.stringify(result).length} å­—ç¬¦`, 'success');
                    displayLog('fullTestResult', `ğŸ“„ è¿”å›æ•°æ®é¢„è§ˆ: ${JSON.stringify(result).substring(0, 200)}...`, 'info');
                    log(`OCR è°ƒç”¨æˆåŠŸ`);

                    displayLog('fullTestResult', `<strong>ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ï¼</strong>`, 'success');
                    log('=== å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ ===');

                } catch (error) {
                    displayLog('fullTestResult', `âŒ OCR API è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    log(`OCR è°ƒç”¨å¤±è´¥: ${error.message}`);
                }

            } catch (error) {
                displayLog('fullTestResult', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>
