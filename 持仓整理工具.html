<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒä»“æ•´ç†å·¥å…· v3.0</title>
    
    <!-- å¼•å…¥ SheetJS åº“ç”¨äº Excel å¯¼å‡ºåŠŸèƒ½ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========== åŸºç¡€æ ·å¼é‡ç½® ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ========== é¡µé¢æ•´ä½“å¸ƒå±€ ========== */
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ========== æ ‡é¢˜æ ·å¼ ========== */
        h1 { 
            text-align: center; 
            color: white; 
            margin-bottom: 20px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        /* ========== å¡ç‰‡æ ·å¼ï¼ˆä¸»è¦å†…å®¹å®¹å™¨ï¼‰ ========== */
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 24px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        }
        .card h2 { 
            color: #5a67d8; 
            margin-bottom: 15px; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        /* ========== è¡¨å•æ ·å¼ ========== */
        .form-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #4a5568; 
        }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s; 
        }
        .form-group input:focus { border-color: #5a67d8; outline: none; }
        
        /* ========== æŒ‰é’®æ ·å¼ ========== */
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); 
        }
        button.secondary { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); }
        button.warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        
        /* ========== è¡¨æ ¼æ ·å¼ ========== */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f7fafc; font-weight: 600; color: #4a5568; }
        tr:hover { background: #f7fafc; }
        
        /* ========== æ­¥éª¤æŒ‡ç¤ºå™¨æ ·å¼ ========== */
        .steps { 
            display: flex; 
            justify-content: center; 
            gap: 0; 
            margin-bottom: 25px; 
        }
        .step { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 15px 25px; 
            background: rgba(255,255,255,0.2); 
            color: white; 
            position: relative; 
        }
        .step:first-child { border-radius: 25px 0 0 25px; }
        .step:last-child { border-radius: 0 25px 25px 0; }
        .step.active { background: white; color: #5a67d8; }
        .step.completed { background: rgba(56, 178, 172, 0.9); }
        .step-num { 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            background: currentColor; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
        }
        .step.active .step-num { background: #5a67d8; color: white; }
        .step.completed .step-num { background: white; color: #38b2ac; }
        
        /* ========== æ±‡æ€»å¡ç‰‡æ ·å¼ ========== */
        .summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        .summary-item { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center; 
            color: white; 
        }
        .summary-item .value { font-size: 28px; font-weight: bold; }
        .summary-item .label { opacity: 0.9; margin-top: 5px; font-size: 14px; }
        
        /* ========== è¡Œä¸šåˆ†æå›¾è¡¨æ ·å¼ ========== */
        .industry-chart { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .industry-bar { margin-bottom: 12px; }
        .industry-bar .label { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 14px; 
        }
        .industry-bar .bar { 
            height: 24px; 
            border-radius: 12px; 
            background: #e2e8f0; 
            overflow: hidden; 
        }
        .industry-bar .fill { 
            height: 100%; 
            border-radius: 12px; 
            transition: width 0.5s; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            padding-right: 8px; 
            color: white; 
            font-size: 12px; 
            font-weight: bold; 
        }
        
        /* ========== äº§å“æ ‡ç­¾é¡µæ ·å¼ ========== */
        .tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .tab { 
            padding: 10px 20px; 
            background: #e2e8f0; 
            border-radius: 8px 8px 0 0; 
            cursor: pointer; 
            font-weight: 600; 
            color: #4a5568; 
            transition: all 0.3s; 
        }
        .tab:hover { background: #cbd5e0; }
        .tab.active { background: #5a67d8; color: white; }
        
        /* ========== æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ ========== */
        .upload-area { 
            border: 3px dashed #cbd5e0; 
            border-radius: 12px; 
            padding: 40px; 
            text-align: center; 
            transition: all 0.3s; 
            cursor: pointer; 
        }
        .upload-area:hover { border-color: #5a67d8; background: #f7fafc; }
        .upload-area .icon { font-size: 48px; margin-bottom: 10px; }
        .upload-area input { display: none; }
        
        /* ========== å›¾ç‰‡é¢„è§ˆç½‘æ ¼æ ·å¼ ========== */
        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .image-item { 
            position: relative; 
            border-radius: 8px; 
            overflow: hidden; 
            cursor: pointer; 
        }
        .image-item img { width: 100%; height: 120px; object-fit: cover; }
        .image-item .name { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            padding: 5px; 
            font-size: 12px; 
            text-overflow: ellipsis; 
            overflow: hidden; \n            white-space: nowrap; 
        }
        
        /* ========== æç¤ºæ¡†æ ·å¼ ========== */
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; }
        .alert-info { background: #ebf8ff; border-left: 4px solid #4299e1; color: #2b6cb0; }
        .alert-success { background: #f0fff4; border-left: 4px solid #48bb78; color: #276749; }
        
        /* ========== è¡Œä¸šåˆ†ç±»æ ‡ç­¾æ ·å¼ï¼ˆå„è¡Œä¸šå¯¹åº”ä¸åŒé¢œè‰²ï¼‰ ========== */
        .cat-tag { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
        }
        .cat-ç¾å›½åŠå¯¼ä½“ { background: #fed7d7; color: #c53030; }
        .cat-Aè‚¡åŠå¯¼ä½“ { background: #feebc8; color: #c05621; }
        .cat-æ¸¯è‚¡FAB { background: #e9d8fd; color: #6b46c1; }
        .cat-ç¾å›½ç®—åŠ› { background: #fefcbf; color: #975a16; }
        .cat-Aè‚¡ç®—åŠ› { background: #bee3f8; color: #2b6cb0; }
        .cat-Aè‚¡èµ„æº { background: #c6f6d5; color: #276749; }
        .cat-æ¸¯è‚¡èµ„æº { background: #b2f5ea; color: #234e52; }
        .cat-Aè‚¡é”‚ç”µå…‰ä¼ { background: #faf089; color: #744210; }
        .cat-äº’è”ç½‘ { background: #c4f1f9; color: #086f83; }
        
        /* ========== å›¾ç‰‡æŸ¥çœ‹å™¨ï¼ˆå…¨å±é¢„è§ˆï¼‰ ========== */
        .viewer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: none; 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
        }
        .viewer img { max-width: 95%; max-height: 95%;}
        .viewer .close { 
            position: absolute; 
            top: 20px; 
            right: 30px; 
            color: white; 
            font-size: 40px; \n            cursor: pointer; 
        }
        
        /* ========== è¡Œä¸šæŸ±çŠ¶å›¾é¢œè‰²ï¼ˆæ¸å˜è‰²ï¼‰ ========== */
        .ind-ç¾å›½åŠå¯¼ä½“ { background: linear-gradient(90deg, #fc8181, #f56565); }
        .ind-Aè‚¡åŠå¯¼ä½“ { background: linear-gradient(90deg, #f6ad55, #ed8936); }
        .ind-æ¸¯è‚¡FAB { background: linear-gradient(90deg, #b794f4, #9f7aea); }
        .ind-ç¾å›½ç®—åŠ› { background: linear-gradient(90deg, #faf089, #ecc94b); }
        .ind-Aè‚¡ç®—åŠ› { background: linear-gradient(90deg, #63b3ed, #4299e1); }
        .ind-Aè‚¡èµ„æº { background: linear-gradient(90deg, #68d391, #48bb78); }
        .ind-æ¸¯è‚¡èµ„æº { background: linear-gradient(90deg, #4fd1c5, #38b2ac); }
        .ind-Aè‚¡é”‚ç”µå…‰ä¼ { background: linear-gradient(90deg, #f6e05e, #ecc94b); }
        .ind-äº’è”ç½‘ { background: linear-gradient(90deg, #76e4f7, #0bc5ea); }
        
        /* ========== å“åº”å¼å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰ ========== */
        @media (max-width: 768px) {
            .industry-chart { grid-template-columns: 1fr; }
            .steps { flex-wrap: wrap; }
            .step { border-radius: 8px !important; margin: 2px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æŒä»“æ•´ç†å·¥å…· v3.0</h1>
        
        <!-- ========== æ­¥éª¤æŒ‡ç¤ºå™¨ ========== -->
        <div class="steps">
            <div class="step active" id="step1"><span class="step-num">1</span> ä¸Šä¼ æˆªå›¾</div>
            <div class="step" id="step2"><span class="step-num">2</span> è¾“å…¥ç°é‡‘ & å¯¼å…¥æ•°æ®</div>
            <div class="step" id="step3"><span class="step-num">3</span> æŸ¥çœ‹ç»“æœ</div>
        </div>

        <!-- ========== æ­¥éª¤1ï¼šä¸Šä¼ æˆªå›¾åŒºåŸŸ ========== -->
        <div class="card" id="card1">
            <h2>ğŸ“· ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æŒä»“æˆªå›¾</h2>

            <!-- ä½¿ç”¨æµç¨‹æç¤º -->
            <div class="alert alert-info">
                <strong>ğŸ’¡ ä½¿ç”¨æµç¨‹ï¼š</strong> ä¸Šä¼ æˆªå›¾é¢„è§ˆ â†’ æŠŠæˆªå›¾å‘ç»™AIåŠ©æ‰‹è¯†åˆ« â†’ AIç”ŸæˆCSV â†’ å¯¼å…¥CSV â†’ æŸ¥çœ‹ç»“æœ
            </div>
            
            <div class="form-row">
                <!-- GTæˆªå›¾ä¸Šä¼ åŒºåŸŸ -->
                <div class="form-group">
                    <label>GTæˆªå›¾ï¼ˆ1-6å·äº§å“ï¼‰</label>
                    <div class="upload-area" onclick="document.getElementById('gtInput').click()">
                        <input type="file" id="gtInput" multiple accept="image/*" onchange="handleUpload(event, 'gt')">
                        <div class="icon">ğŸ“¤</div>
                        <div>ç‚¹å‡»ä¸Šä¼ GTæˆªå›¾ï¼ˆæ”¯æŒå¤šå¼ ï¼‰</div>
                    </div>
                    <div class="image-grid" id="gtGrid"></div>
                </div>
                
                <!-- TRSæˆªå›¾ä¸Šä¼ åŒºåŸŸ -->
                <div class="form-group">
                    <label>TRSæˆªå›¾ï¼ˆ1å·å’Œ2å·äº§å“ï¼Œå¦‚æœ‰ï¼‰</label>
                    <div class="upload-area" onclick="document.getElementById('trsInput').click()">
                        <input type="file" id="trsInput" multiple accept="image/*" onchange="handleUpload(event, 'trs')">
                        <div class="icon">ğŸ“¤</div>
                        <div>ç‚¹å‡»ä¸Šä¼ TRSæˆªå›¾</div>
                    </div>
                    <div class="image-grid" id="trsGrid"></div>
                </div>
            </div>
        </div>

        <!-- ========== æ­¥éª¤2ï¼šè¾“å…¥ç°é‡‘ & å¯¼å…¥æ•°æ® ========== -->
        <div class="card" id="card2">
            <h2>ğŸ’° ç¬¬äºŒæ­¥ï¼šè¾“å…¥ç°é‡‘ & å¯¼å…¥æ•°æ®</h2>
            
            <!-- å„äº§å“ç°é‡‘è¾“å…¥æ¡† -->
            <div class="form-row">
                <div class="form-group">
                    <label>1å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash1" value="3" step="0.01" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>2å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash2" value="140" step="0.01" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>5å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash5" value="9" step="0.01" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>6å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash6" value="59" step="0.01" onchange="calculate()">
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’®ç»„ -->
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="secondary" onclick="importCSV()">ğŸ“¥ å¯¼å…¥AIè¯†åˆ«çš„CSV</button>
                <button class="warning" onclick="loadSample()">ğŸ“‹ åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                <button onclick="exportExcel()">ğŸ“¤ å¯¼å‡ºExcelæŠ¥è¡¨</button>
            </div>
            
            <!-- éšè—çš„CSVæ–‡ä»¶è¾“å…¥æ¡† -->
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSV(event)">
        </div>

        <!-- ========== æ­¥éª¤3ï¼šæŸ¥çœ‹ç»“æœ ========== -->
        <div class="card" id="card3">
            <h2>ğŸ“ˆ ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹ç»“æœ</h2>
            
            <!-- æ€»ä½“æ±‡æ€»ç»Ÿè®¡ -->
            <h3 style="color:#5a67d8;margin-bottom:15px;">ğŸ’¼ æ‰€æœ‰äº§å“æ±‡æ€»</h3>
            <div class="summary" id="summary">
                <div class="summary-item">
                    <div class="value" id="totalAssets">0</div>
                    <div class="label">æ€»èµ„äº§(ä¸‡å…ƒ)</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="totalMarket">0</div>
                    <div class="label">å¸‚å€¼åˆè®¡(ä¸‡å…ƒ)</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="totalCash">0</div>
                    <div class="label">ç°é‡‘åˆè®¡(ä¸‡å…ƒ)</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="stockCount">0</div>
                    <div class="label">æŒä»“æ•°é‡</div>
                </div>
            </div>
            
            <!-- è¡Œä¸šå æ¯”åˆ†æåŒºåŸŸ -->
            <h3 style="color:#5a67d8;margin:25px 0 15px;">ğŸ“Š è¡Œä¸šå æ¯”åˆ†æ</h3>
            <div class="industry-chart">
                <div id="industryBars"></div>  <!-- æŸ±çŠ¶å›¾ -->
                <div id="industryTable"></div> <!-- æ˜ç»†è¡¨æ ¼ -->
            </div>
            
            <!-- åˆ†äº§å“æŒä»“æ˜ç»† -->
            <h3 style="color:#5a67d8;margin:25px 0 15px;">ğŸ“‹ åˆ†äº§å“æŒä»“æ˜ç»†</h3>
            
            <!-- äº§å“æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('1å·')">1å·äº§å“</div>
                <div class="tab" onclick="switchTab('2å·')">2å·äº§å“</div>
                <div class="tab" onclick="switchTab('5å·')">5å·äº§å“</div>
                <div class="tab" onclick="switchTab('6å·')">6å·äº§å“</div>
                <div class="tab" onclick="switchTab('all')">å…¨éƒ¨æ±‡æ€»</div>
            </div>
            
            <!-- æŒä»“æ˜ç»†è¡¨æ ¼å®¹å™¨ -->
            <div id="holdingsTable"></div>
        </div>
    </div>

    <!-- ========== å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨ ========== -->
    <div class="viewer" id="viewer" onclick="closeViewer()">
        <span class="close">&times;</span>
        <img id="viewerImg" src="">
    </div>

    <script>
        // ================================================================
        // å…¨å±€å˜é‡å®šä¹‰
        // ================================================================
        
        /**
         * æŒä»“æ•°æ®æ•°ç»„
         * æ¯æ¡è®°å½•æ ¼å¼: { product: '1å·', stock: 'ä¸‡é‡ŒçŸ³', value: 4115.10, category: 'Aè‚¡èµ„æº' }
         */
        let holdings = [];
        
        /**
         * å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µ
         * å¯é€‰å€¼: '1å·', '2å·', '5å·', '6å·', 'all'
         */
        let currentTab = '1å·';
        
        /**
         * ä¸Šä¼ çš„æˆªå›¾æ•°ç»„
         * æ ¼å¼: { name: 'æ–‡ä»¶å', src: 'base64ç¼–ç çš„å›¾ç‰‡æ•°æ®' }
         */
        let gtImages = [];   // GTæˆªå›¾
        let trsImages = [];  // TRSæˆªå›¾
        
        // ================================================================
        // è¡Œä¸šåˆ†ç±»é…ç½®
        // ================================================================
        
        /**
         * è‚¡ç¥¨åç§° â†’ è¡Œä¸šåˆ†ç±» æ˜ å°„è¡¨
         * ç”¨äºè‡ªåŠ¨è¯†åˆ«è‚¡ç¥¨æ‰€å±è¡Œä¸š
         */
        const categoryMap = {
            // ç¾å›½åŠå¯¼ä½“
            'åŠå¯¼ä½“ä¸‰å€åšå¤š': 'ç¾å›½åŠå¯¼ä½“', 
            'SOXL': 'ç¾å›½åŠå¯¼ä½“', 
            'è‹±ç‰¹å°”': 'ç¾å›½åŠå¯¼ä½“',
            
            // ç¾å›½ç®—åŠ›
            'Lumentumæ§è‚¡': 'ç¾å›½ç®—åŠ›',
            
            // Aè‚¡åŠå¯¼ä½“
            'åŠå¯¼ä½“è®¾å¤‡ETF': 'Aè‚¡åŠå¯¼ä½“', 
            'ä¸­å¾®å…¬å¸': 'Aè‚¡åŠå¯¼ä½“',
            
            // Aè‚¡ç®—åŠ›
            'æ¶¦æ³½ç§‘æŠ€': 'Aè‚¡ç®—åŠ›', 
            'èƒœå®ç§‘æŠ€': 'Aè‚¡ç®—åŠ›', 
            'æ–°æ˜“ç››': 'Aè‚¡ç®—åŠ›', 
            'ä¸­é™…æ—­åˆ›': 'Aè‚¡ç®—åŠ›',
            
            // Aè‚¡èµ„æº
            'ä¸‡é‡ŒçŸ³': 'Aè‚¡èµ„æº', 
            'åè”æ§è‚¡': 'Aè‚¡èµ„æº', 
            'ç››å±¯çŸ¿ä¸š': 'Aè‚¡èµ„æº', 
            'æ°ç‘è‚¡ä»½': 'Aè‚¡èµ„æº',
            
            // æ¸¯è‚¡èµ„æº
            'åŠ›å‹¤èµ„æº': 'æ¸¯è‚¡èµ„æº', 
            'ä¸­æ ¸å›½é™…': 'æ¸¯è‚¡èµ„æº',
            
            // Aè‚¡é”‚ç”µå…‰ä¼
            'å…ˆå¯¼æ™ºèƒ½': 'Aè‚¡é”‚ç”µå…‰ä¼',
            
            // æ¸¯è‚¡FAB
            'ä¸­èŠ¯å›½é™…': 'æ¸¯è‚¡FAB',
            
            // äº’è”ç½‘
            'è°·æ­ŒA': 'äº’è”ç½‘', 
            'GGLL': 'äº’è”ç½‘'
        };
        
        /**
         * è¡Œä¸šæ˜¾ç¤ºé¡ºåºï¼ˆç”¨äºæ’åºï¼‰
         */
        const industryOrder = [
            'Aè‚¡èµ„æº', 'Aè‚¡ç®—åŠ›', 'Aè‚¡åŠå¯¼ä½“', 
            'æ¸¯è‚¡FAB', 'æ¸¯è‚¡èµ„æº', 
            'ç¾å›½åŠå¯¼ä½“', 'ç¾å›½ç®—åŠ›', 
            'Aè‚¡é”‚ç”µå…‰ä¼', 'äº’è”ç½‘'
        ];

        // ================================================================
        // å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆåŠŸèƒ½
        // ================================================================
        
        /**
         * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
         * @param {Event} e - æ–‡ä»¶è¾“å…¥äº‹ä»¶
         * @param {string} type - ä¸Šä¼ ç±»å‹ ('gt' æˆ– 'trs')
         */
        function handleUpload(e, type) {
            const files = e.target.files;
            const grid = document.getElementById(type + 'Grid');
            const arr = type === 'gt' ? gtImages : trsImages;
            
            // æ¸…ç©ºä¹‹å‰çš„å›¾ç‰‡
            arr.length = 0;
            grid.innerHTML = '';
            
            // éå†ä¸Šä¼ çš„æ¯ä¸ªæ–‡ä»¶
            for (let f of files) {
                const reader = new FileReader();
                
                reader.onload = function(ev) {
                    // ä¿å­˜å›¾ç‰‡æ•°æ®
                    arr.push({ name: f.name, src: ev.target.result });
                    
                    // åˆ›å»ºé¢„è§ˆå…ƒç´ 
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.innerHTML = `
                        <img src="${ev.target.result}" onclick="openViewer('${ev.target.result.replace(/'/g, "\\'")}')">
                        <div class="name">${f.name}</div>
                    `;
                    grid.appendChild(div);
                };
                
                // ä»¥ DataURL æ ¼å¼è¯»å–æ–‡ä»¶
                reader.readAsDataURL(f);
            }
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨çŠ¶æ€
            updateSteps();
        }

        /**
         * æ‰“å¼€å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨
         * @param {string} src - å›¾ç‰‡çš„ base64 æ•°æ®
         */
        function openViewer(src) { 
            document.getElementById('viewerImg').src = src; 
            document.getElementById('viewer').style.display = 'flex'; 
        }
        
        /**
         * å…³é—­å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨
         */
        function closeViewer() { 
            document.getElementById('viewer').style.display = 'none'; 
        }

        // ================================================================
        // ç°é‡‘ç›¸å…³è®¡ç®—å‡½æ•°
        // ================================================================
        
        /**
         * è·å–æŒ‡å®šäº§å“çš„ç°é‡‘é‡‘é¢
         * @param {string} p - äº§å“ç¼–å·ï¼ˆå¦‚ '1å·', '2å·'ï¼‰
         * @returns {number} ç°é‡‘é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
         */
        function getCash(p) { 
            return parseFloat(document.getElementById('cash' + p.replace('å·','')).value) || 0; 
        }
        
        /**
         * è®¡ç®—æ‰€æœ‰äº§å“çš„ç°é‡‘æ€»é¢
         * @returns {number} ç°é‡‘æ€»é¢ï¼ˆä¸‡å…ƒï¼‰
         */
        function getTotalCash() { 
            return getCash('1å·') + getCash('2å·') + getCash('5å·') + getCash('6å·'); 
        }

        // ================================================================
        // æ ¸å¿ƒè®¡ç®—ä¸æ¸²æŸ“å‡½æ•°
        // ================================================================
        
        /**
         * ä¸»è®¡ç®—å‡½æ•°ï¼šè®¡ç®—å¹¶æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®
         * åœ¨æ•°æ®å˜åŒ–æ—¶è°ƒç”¨ï¼ˆå¯¼å…¥æ•°æ®ã€ä¿®æ”¹ç°é‡‘ç­‰ï¼‰
         */
        function calculate() {
            // è®¡ç®—æ€»å¸‚å€¼ï¼ˆæ‰€æœ‰æŒä»“çš„å¸‚å€¼ä¹‹å’Œï¼‰
            const totalMarket = holdings.reduce((sum, h) => sum + h.value, 0);
            
            // è·å–ç°é‡‘æ€»é¢
            const totalCash = getTotalCash();
            
            // è®¡ç®—æ€»èµ„äº§
            const totalAssets = totalMarket + totalCash;
            
            // æ›´æ–°æ±‡æ€»æ˜¾ç¤º
            document.getElementById('totalAssets').textContent = totalAssets.toFixed(2);
            document.getElementById('totalMarket').textContent = totalMarket.toFixed(2);
            document.getElementById('totalCash').textContent = totalCash.toFixed(2);
            document.getElementById('stockCount').textContent = holdings.length;
            
            // æ¸²æŸ“è¡Œä¸šå æ¯”åˆ†æ
            renderIndustry(totalAssets);
            
            // æ¸²æŸ“æŒä»“æ˜ç»†è¡¨æ ¼
            renderTable();
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            updateSteps();
        }

        /**
         * æ¸²æŸ“è¡Œä¸šå æ¯”åˆ†æ
         * åŒ…æ‹¬æŸ±çŠ¶å›¾å’Œæ˜ç»†è¡¨æ ¼
         * @param {number} totalAssets - æ€»èµ„äº§ï¼ˆä¸‡å…ƒï¼‰
         */
        function renderIndustry(totalAssets) {
            // æŒ‰è¡Œä¸šæ±‡æ€»å¸‚å€¼
            const indMap = {};
            holdings.forEach(h => {
                if (!indMap[h.category]) indMap[h.category] = 0;
                indMap[h.category] += h.value;
            });
            
            // æ·»åŠ ç°é‡‘é¡¹
            indMap['ç°é‡‘'] = getTotalCash();
            
            // æŒ‰å¸‚å€¼é™åºæ’åº
            const sorted = Object.entries(indMap).sort((a, b) => b[1] - a[1]);
            
            // ===== æ¸²æŸ“æŸ±çŠ¶å›¾ =====
            let barsHtml = '';
            sorted.forEach(([ind, val]) => {
                const pct = totalAssets > 0 ? (val / totalAssets * 100) : 0;
                const colorClass = ind === 'ç°é‡‘' ? '' : 'ind-' + ind;
                
                barsHtml += `
                    <div class="industry-bar">
                        <div class="label">
                            <span>${ind}</span>
                            <span>${val.toFixed(2)}ä¸‡ (${pct.toFixed(2)}%)</span>
                        </div>
                        <div class="bar">
                            <div class="fill ${colorClass}" style="width:${pct}%">
                                ${pct > 5 ? pct.toFixed(1) + '%' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('industryBars').innerHTML = barsHtml;
            
            // ===== æ¸²æŸ“æ˜ç»†è¡¨æ ¼ =====
            let tableHtml = '<table><tr><th>è¡Œä¸šåˆ†ç±»</th><th>å¸‚å€¼(ä¸‡)</th><th>å æ¯”</th></tr>';
            
            sorted.forEach(([ind, val]) => {
                const pct = totalAssets > 0 ? (val / totalAssets * 100) : 0;
                const tagClass = ind === 'ç°é‡‘' ? '' : 'cat-' + ind;
                
                tableHtml += `
                    <tr>
                        <td><span class="cat-tag ${tagClass}">${ind}</span></td>
                        <td>${val.toFixed(2)}</td>
                        <td>${pct.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            // æ·»åŠ åˆè®¡è¡Œ
            tableHtml += `
                <tr style="font-weight:bold;background:#f7fafc;">
                    <td>åˆè®¡</td>
                    <td>${totalAssets.toFixed(2)}</td>
                    <td>100%</td>
                </tr>
            </table>`;
            
            document.getElementById('industryTable').innerHTML = tableHtml;
        }

        /**
         * åˆ‡æ¢äº§å“æ ‡ç­¾é¡µ
         * @param {string} tab - ç›®æ ‡æ ‡ç­¾é¡µï¼ˆ'1å·', '2å·', '5å·', '6å·', 'all'ï¼‰
         */
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderTable();
        }

        /**
         * æ¸²æŸ“æŒä»“æ˜ç»†è¡¨æ ¼
         * æ ¹æ®å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µè¿‡æ»¤æ•°æ®
         */
        function renderTable() {
            // æ ¹æ®å½“å‰æ ‡ç­¾é¡µè¿‡æ»¤æ•°æ®
            let filtered = currentTab === 'all' 
                ? [...holdings] 
                : holdings.filter(h => h.product === currentTab);
            
            // å¦‚æœæ˜¯å…¨éƒ¨æ±‡æ€»ï¼Œåˆå¹¶åŒåè‚¡ç¥¨
            if (currentTab === 'all') {
                const merged = {};
                filtered.forEach(h => {
                    if (!merged[h.stock]) {
                        merged[h.stock] = { stock: h.stock, value: 0, category: h.category };
                    }
                    merged[h.stock].value += h.value;
                });
                filtered = Object.values(merged);
            }
            
            // è®¡ç®—å½“å‰è§†å›¾çš„ç°é‡‘å’Œæ€»èµ„äº§
            const cash = currentTab === 'all' ? getTotalCash() : getCash(currentTab);
            const totalMarket = filtered.reduce((sum, h) => sum + h.value, 0);
            const totalAsset = totalMarket + cash;
            
            // æ„å»ºè¡¨æ ¼HTML
            let html = '<table><tr><th>è‚¡ç¥¨åç§°</th><th>å¸‚å€¼(ä¸‡)</th><th>å æ¯”</th><th>è¡Œä¸šåˆ†ç±»</th></tr>';
            
            // æŒ‰å¸‚å€¼é™åºæ’åˆ—æŒä»“
            filtered.sort((a, b) => b.value - a.value).forEach(h => {
                const pct = totalAsset > 0 ? (h.value / totalAsset * 100).toFixed(2) : 0;
html += `
                    <tr>
                        <td>${h.stock}</td>
                        <td>${h.value.toFixed(2)}</td>
                        <td>${pct}%</td>
                        <td><span class="cat-tag cat-${h.category}">${h.category}</span></td>
                    </tr>
                `;
            });
            
            // æ·»åŠ ç°é‡‘è¡Œ
            html += `
                <tr style="background:#ebf8ff;">
                    <td>ç°é‡‘</td>
                    <td>${cash.toFixed(2)}</td>
                    <td>${totalAsset > 0 ? (cash / totalAsset * 100).toFixed(2) : 0}%</td>
                    <td>-</td>
                </tr>
            `;
            
            // æ·»åŠ åˆè®¡è¡Œ
            html += `
                <tr style="font-weight:bold;background:#f0fff4;">
                    <td>åˆè®¡</td>
                    <td>${totalAsset.toFixed(2)}</td>
                    <td>100%</td>
                    <td>-</td>
                </tr>
            </table>`;
            
            document.getElementById('holdingsTable').innerHTML = html;
        }

        /**
         * æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨çŠ¶æ€
         * æ ¹æ®å½“å‰è¿›åº¦é«˜äº®å¯¹åº”æ­¥éª¤
         */
        function updateSteps() {
            const hasImg = gtImages.length > 0 || trsImages.length > 0;
            const hasData = holdings.length > 0;
            
            // è®¾ç½®å„æ­¥éª¤çš„çŠ¶æ€
            document.getElementById('step1').className = 'step' + (hasImg ? ' completed' : ' active');
            document.getElementById('step2').className = 'step' + (hasData ? ' completed' : (hasImg ? ' active' : ''));
            document.getElementById('step3').className = 'step' + (hasData ? ' active' : '');
        }

        // ================================================================
        // CSV å¯¼å…¥åŠŸèƒ½
        // ================================================================
        
        /**
         * è§¦å‘CSVæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
         */
        function importCSV() { 
            document.getElementById('csvInput').click(); 
        }
        
        /**
         * å¤„ç†CSVæ–‡ä»¶å¯¼å…¥
         * CSVæ ¼å¼è¦æ±‚ï¼šäº§å“,è‚¡ç¥¨åç§°,å¸‚å€¼(ä¸‡å…ƒ),æ•°é‡,è¡Œä¸šåˆ†ç±»
         * @param {Event} e - æ–‡ä»¶è¾“å…¥äº‹ä»¶
         */
        function handleCSV(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(ev) {
                // æŒ‰è¡Œåˆ†å‰²CSVå†…å®¹
                const lines = ev.target.result.split('\n');
                
                // æ¸…ç©ºç°æœ‰æ•°æ®
                holdings = [];
                
                // ä»ç¬¬2è¡Œå¼€å§‹è§£æï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    
                    // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                    if (cols.length >= 3 && cols[0] && cols[1] && parseFloat(cols[2])) {
                        const product = cols[0].trim();       // äº§å“ç¼–å·
                        const stock = cols[1].trim();         // è‚¡ç¥¨åç§°
                        const value = parseFloat(cols[2]);    // å¸‚å€¼
                        
                        // è·å–è¡Œä¸šåˆ†ç±»ï¼ˆä¼˜å…ˆä½¿ç”¨CSVä¸­çš„åˆ†ç±»ï¼Œå¦åˆ™ä»æ˜ å°„è¡¨æŸ¥æ‰¾ï¼‰
                        let category = cols.length > 4 
                            ? cols[4].trim() 
                            : (categoryMap[stock] || 'Aè‚¡èµ„æº');
                        
                        // æ’é™¤ç°é‡‘å’Œåˆè®¡è¡Œ
                        if (stock !== 'ç°é‡‘' && !stock.includes('åˆè®¡')) {
                            holdings.push({ product, stock, value, category });
                        }
                    }
                }
                
                // é‡æ–°è®¡ç®—å¹¶æ¸²æŸ“
                calculate();
                alert('å¯¼å…¥æˆåŠŸï¼å…± ' + holdings.length + ' æ¡è®°å½•');
            };
            
            // ä»¥UTF-8ç¼–ç è¯»å–æ–‡ä»¶
            reader.readAsText(file, 'UTF-8');
        }

        // ================================================================
        // ç¤ºä¾‹æ•°æ®åŠ è½½
        // ================================================================
        
        /**
         * åŠ è½½é¢„è®¾çš„ç¤ºä¾‹æ•°æ®
         * ç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•åŠŸèƒ½
         */
        function loadSample() {
            holdings = [
                // ===== 1å·äº§å“æŒä»“ =====
                { product:'1å·', stock:'ä¸‡é‡ŒçŸ³', value:4115.10, category:'Aè‚¡èµ„æº' },
                { product:'1å·', stock:'åŠ›å‹¤èµ„æº', value:1347.12, category:'æ¸¯è‚¡èµ„æº' },
                { product:'1å·', stock:'ä¸­é™…æ—­åˆ›', value:1120.66, category:'Aè‚¡ç®—åŠ›' },
                { product:'1å·', stock:'ä¸­èŠ¯å›½é™…', value:1052.87, category:'æ¸¯è‚¡FAB' },
                { product:'1å·', stock:'åŠå¯¼ä½“ä¸‰å€åšå¤š', value:992.66, category:'ç¾å›½åŠå¯¼ä½“' },
                { product:'1å·', stock:'åŠå¯¼ä½“è®¾å¤‡ETF', value:990.14, category:'Aè‚¡åŠå¯¼ä½“' },
                { product:'1å·', stock:'ç››å±¯çŸ¿ä¸š', value:782.13, category:'Aè‚¡èµ„æº' },
                { product:'1å·', stock:'æ¶¦æ³½ç§‘æŠ€', value:703.04, category:'Aè‚¡ç®—åŠ›' },
                { product:'1å·', stock:'GGLL', value:623.70, category:'äº’è”ç½‘' },
                { product:'1å·', stock:'èƒœå®ç§‘æŠ€', value:616.01, category:'Aè‚¡ç®—åŠ›' },
                { product:'1å·', stock:'åè”æ§è‚¡', value:551.52, category:'Aè‚¡èµ„æº' },
                { product:'1å·', stock:'æ–°æ˜“ç››', value:475.98, category:'Aè‚¡ç®—åŠ›' },
                { product:'1å·', stock:'Lumentumæ§è‚¡', value:397.78, category:'ç¾å›½ç®—åŠ›' },
                { product:'1å·', stock:'å…ˆå¯¼æ™ºèƒ½', value:372.96, category:'Aè‚¡é”‚ç”µå…‰ä¼' },
                { product:'1å·', stock:'ä¸­æ ¸å›½é™…', value:280.45, category:'æ¸¯è‚¡èµ„æº' },
                { product:'1å·', stock:'ä¸­å¾®å…¬å¸', value:262.81, category:'Aè‚¡åŠå¯¼ä½“' },
                { product:'1å·', stock:'è°·æ­ŒA', value:19.70, category:'äº’è”ç½‘' },
                
                // ===== 2å·äº§å“æŒä»“ =====
                { product:'2å·', stock:'ä¸‡é‡ŒçŸ³', value:1940.56, category:'Aè‚¡èµ„æº' },
                { product:'2å·', stock:'èƒœå®ç§‘æŠ€', value:477.61, category:'Aè‚¡ç®—åŠ›' },
                { product:'2å·', stock:'ä¸­é™…æ—­åˆ›', value:464.11, category:'Aè‚¡ç®—åŠ›' },
                { product:'2å·', stock:'ç››å±¯çŸ¿ä¸š', value:433.58, category:'Aè‚¡èµ„æº' },
                { product:'2å·', stock:'åè”æ§è‚¡', value:410.57, category:'Aè‚¡èµ„æº' },
                { product:'2å·', stock:'åŠ›å‹¤èµ„æº', value:388.47, category:'æ¸¯è‚¡èµ„æº' },
                { product:'2å·', stock:'ä¸­èŠ¯å›½é™…', value:387.41, category:'æ¸¯è‚¡FAB' },
                { product:'2å·', stock:'ä¸­å¾®å…¬å¸', value:383.58, category:'Aè‚¡åŠå¯¼ä½“' },
                { product:'2å·', stock:'æ¶¦æ³½ç§‘æŠ€', value:364.91, category:'Aè‚¡ç®—åŠ›' },
                { product:'2å·', stock:'åŠå¯¼ä½“ä¸‰å€åšå¤š', value:321.94, category:'ç¾å›½åŠå¯¼ä½“' },
                { product:'2å·', stock:'GGLL', value:283.18, category:'äº’è”ç½‘' },
                { product:'2å·', stock:'æ–°æ˜“ç››', value:280.91, category:'Aè‚¡ç®—åŠ›' },
                { product:'2å·', stock:'æ°ç‘è‚¡ä»½', value:252.60, category:'Aè‚¡èµ„æº' },
                { product:'2å·', stock:'å…ˆå¯¼æ™ºèƒ½', value:187.95, category:'Aè‚¡é”‚ç”µå…‰ä¼' },
                { product:'2å·', stock:'Lumentumæ§è‚¡', value:184.97, category:'ç¾å›½ç®—åŠ›' },
                { product:'2å·', stock:'ä¸­æ ¸å›½é™…', value:24.07, category:'æ¸¯è‚¡èµ„æº' },
                
                // ===== 5å·äº§å“æŒä»“ =====
                { product:'5å·', stock:'ä¸‡é‡ŒçŸ³', value:945.45, category:'Aè‚¡èµ„æº' },
                { product:'5å·', stock:'ä¸­é™…æ—­åˆ›', value:237.72, category:'Aè‚¡ç®—åŠ›' },
                { product:'5å·', stock:'è°·æ­ŒA', value:215.39, category:'äº’è”ç½‘' },
                { product:'5å·', stock:'ä¸­èŠ¯å›½é™…', value:199.95, category:'æ¸¯è‚¡FAB' },
                { product:'5å·', stock:'åŠå¯¼ä½“è®¾å¤‡ETF', value:191.48, category:'Aè‚¡åŠå¯¼ä½“' },
                { product:'5å·', stock:'åè”æ§è‚¡', value:150.74, category:'Aè‚¡èµ„æº' },
                { product:'5å·', stock:'æ¶¦æ³½ç§‘æŠ€', value:137.70, category:'Aè‚¡ç®—åŠ›' },
                { product:'5å·', stock:'ç››å±¯çŸ¿ä¸š', value:132.23, category:'Aè‚¡èµ„æº' },
                { product:'5å·', stock:'åŠå¯¼ä½“ä¸‰å€åšå¤š', value:129.20, category:'ç¾å›½åŠå¯¼ä½“' },
                { product:'5å·', stock:'æ°ç‘è‚¡ä»½', value:118.93, category:'Aè‚¡èµ„æº' },
                { product:'5å·', stock:'è‹±ç‰¹å°”', value:116.98, category:'ç¾å›½åŠå¯¼ä½“' },
                { product:'5å·', stock:'æ–°æ˜“ç››', value:109.24, category:'Aè‚¡ç®—åŠ›' },
                { product:'5å·', stock:'Lumentumæ§è‚¡', value:106.12, category:'ç¾å›½ç®—åŠ›' },
                { product:'5å·', stock:'èƒœå®ç§‘æŠ€', value:92.27, category:'Aè‚¡ç®—åŠ›' },
                { product:'5å·', stock:'å…ˆå¯¼æ™ºèƒ½', value:73.19, category:'Aè‚¡é”‚ç”µå…‰ä¼' },
                { product:'5å·', stock:'ä¸­å¾®å…¬å¸', value:66.83, category:'Aè‚¡åŠå¯¼ä½“' },
                { product:'5å·', stock:'ä¸­æ ¸å›½é™…', value:51.48, category:'æ¸¯è‚¡èµ„æº' },
                
                // ===== 6å·äº§å“æŒä»“ =====
                { product:'6å·', stock:'ä¸‡é‡ŒçŸ³', value:274.09, category:'Aè‚¡èµ„æº' },
                { product:'6å·', stock:'ä¸­é™…æ—­åˆ›', value:62.26, category:'Aè‚¡ç®—åŠ›' },
                { product:'6å·', stock:'ä¸­èŠ¯å›½é™…', value:56.24, category:'æ¸¯è‚¡FAB' },
                { product:'6å·', stock:'åŠå¯¼ä½“è®¾å¤‡ETF', value:55.46, category:'Aè‚¡åŠå¯¼ä½“' },
                { product:'6å·', stock:'ç››å±¯çŸ¿ä¸š', value:47.83, category:'Aè‚¡èµ„æº' },
                { product:'6å·', stock:'åè”æ§è‚¡', value:44.18, category:'Aè‚¡èµ„æº' },
                { product:'6å·', stock:'æ¶¦æ³½ç§‘æŠ€', value:39.78, category:'Aè‚¡ç®—åŠ›' },
                { product:'6å·', stock:'æ°ç‘è‚¡ä»½', value:34.11, category:'Aè‚¡èµ„æº' },
                { product:'6å·', stock:'è‹±ç‰¹å°”', value:33.88, category:'ç¾å›½åŠå¯¼ä½“' },
                { product:'6å·', stock:'åŠå¯¼ä½“ä¸‰å€åšå¤š', value:32.84, category:'ç¾å›½åŠå¯¼ä½“' },
                { product:'6å·', stock:'è°·æ­ŒA', value:27.81, category:'äº’è”ç½‘' },
                { product:'6å·', stock:'èƒœå®ç§‘æŠ€', value:27.14, category:'Aè‚¡ç®—åŠ›' },
                { product:'6å·', stock:'æ–°æ˜“ç››', value:27.31, category:'Aè‚¡ç®—åŠ›' },
                { product:'6å·', stock:'Lumentumæ§è‚¡', value:25.72, category:'ç¾å›½ç®—åŠ›' },
                { product:'6å·', stock:'å…ˆå¯¼æ™ºèƒ½', value:21.66, category:'Aè‚¡é”‚ç”µå…‰ä¼' },
                { product:'6å·', stock:'ä¸­æ ¸å›½é™…', value:19.03, category:'æ¸¯è‚¡èµ„æº' }
            ];
            
            // é‡æ–°è®¡ç®—å¹¶æ¸²æŸ“
            calculate();
            alert('ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸï¼');
        }

        // ================================================================
        // Excel å¯¼å‡ºåŠŸèƒ½
        // ================================================================
        
        /**
         * å¯¼å‡ºæ•°æ®åˆ° Excel æ–‡ä»¶
         * ä½¿ç”¨ SheetJS åº“ç”Ÿæˆ xlsx æ ¼å¼æ–‡ä»¶
         */
        function exportExcel() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (holdings.length === 0) { 
                alert('è¯·å…ˆå¯¼å…¥æ•°æ®'); 
                return; 
            }
            
            const data = [];
            
            // ===== æŒ‰äº§å“åˆ†ç»„å¯¼å‡º =====
            ['1å·', '2å·', '5å·', '6å·'].forEach(p => {
                const filtered = holdings.filter(h => h.product === p);
                if (filtered.length === 0) return;
                
                const cash = getCash(p);
                const total = filtered.reduce((s, h) => s + h.value, 0) + cash;
                
                // æ·»åŠ æŒä»“è®°å½•ï¼ˆæŒ‰å¸‚å€¼é™åºï¼‰
                filtered.sort((a, b) => b.value - a.value).forEach(h => {
                    data.push({
                        'äº§å“': p, 
                        'è‚¡ç¥¨åç§°': h.stock, 
                        'å¸‚å€¼(ä¸‡å…ƒ)': h.value, 
                        'å æ¯”': (h.value / total * 100).toFixed(2) + '%', 
                        'è¡Œä¸šåˆ†ç±»': h.category
                    });
                });
                
                // æ·»åŠ ç°é‡‘è¡Œ
                data.push({
                    'äº§å“': p, 
                    'è‚¡ç¥¨åç§°': 'ç°é‡‘', 
                    'å¸‚å€¼(ä¸‡å…ƒ)': cash, 
                    'å æ¯”': (cash / total * 100).toFixed(2) + '%', 
                    'è¡Œä¸šåˆ†ç±»': '-'
                });
                
                // æ·»åŠ åˆè®¡è¡Œ
                data.push({
                    'äº§å“': p, 
                    'è‚¡ç¥¨åç§°': 'ã€åˆè®¡ã€‘', 
                    'å¸‚å€¼(ä¸‡å…ƒ)': total, 
                    'å æ¯”': '100%', 
                    'è¡Œä¸šåˆ†ç±»': '-'
                });
                
                // æ·»åŠ ç©ºè¡Œåˆ†éš”
                data.push({
                    'äº§å“': '', 
                    'è‚¡ç¥¨åç§°': '', 
                    'å¸‚å€¼(ä¸‡å…ƒ)': '', 
                    'å æ¯”': '', 
                    'è¡Œä¸šåˆ†ç±»': ''
                });
            });
            
            // ===== æ·»åŠ è¡Œä¸šæ±‡æ€» =====
            data.push({
                'äº§å“': 'ã€è¡Œä¸šæ±‡æ€»ã€‘', 
                'è‚¡ç¥¨åç§°': '', 
                'å¸‚å€¼(ä¸‡å…ƒ)': '', 
                'å æ¯”': '', 
                'è¡Œä¸šåˆ†ç±»': ''
            });
            
            const totalAssets = holdings.reduce((s, h) => s + h.value, 0) + getTotalCash();
            
            // æŒ‰è¡Œä¸šæ±‡æ€»
            const indMap = {};
            holdings.forEach(h => { 
                indMap[h.category] = (indMap[h.category] || 0) + h.value; 
            });
            indMap['ç°é‡‘'] = getTotalCash();
            
            // æŒ‰å¸‚å€¼é™åºè¾“å‡º
            Object.entries(indMap).sort((a, b) => b[1] - a[1]).forEach(([ind, val]) => {
                data.push({
                    'äº§å“': '', 
                    'è‚¡ç¥¨åç§°': ind, 
                    'å¸‚å€¼(ä¸‡å…ƒ)': val, 
                    'å æ¯”': (val / totalAssets * 100).toFixed(2) + '%', 
                    'è¡Œä¸šåˆ†ç±»': ''
                });
            });
            
            // ===== ä½¿ç”¨ SheetJS ç”Ÿæˆ Excel æ–‡ä»¶ =====
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æŒä»“æ±‡æ€»');
            
            // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¥æœŸï¼‰
            const fileName = `æŒä»“æ±‡æ€»_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('ExcelæŠ¥è¡¨å·²å¯¼å‡ºï¼');
        }

        // ================================================================
        // äº‹ä»¶ç›‘å¬å™¨
        // ================================================================
        
        // ESC é”®å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
        document.addEventListener('keydown', e => { 
            if (e.key === 'Escape') closeViewer(); 
        });
        
        // ================================================================
        // é¡µé¢åˆå§‹åŒ–
        // ================================================================
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹è®¡ç®—
        calculate();
    </script>
</body>
</html>
