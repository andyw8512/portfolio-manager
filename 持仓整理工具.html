<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒä»“æ•´ç†å·¥å…· v1.1</title>
    
    <!-- å¼•å…¥ SheetJS åº“ç”¨äº Excel å¯¼å‡ºåŠŸèƒ½ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ========== åŸºç¡€æ ·å¼é‡ç½® ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ========== é¡µé¢æ•´ä½“å¸ƒå±€ ========== */
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ========== æ ‡é¢˜æ ·å¼ ========== */
        h1 { 
            text-align: center; 
            color: white; 
            margin-bottom: 20px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        /* ========== å¡ç‰‡æ ·å¼ï¼ˆä¸»è¦å†…å®¹å®¹å™¨ï¼‰ ========== */
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 24px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        }
        .card h2 { 
            color: #5a67d8; 
            margin-bottom: 15px; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        /* ========== è¡¨å•æ ·å¼ ========== */
        .form-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #4a5568; 
        }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s; 
        }
        .form-group input:focus { border-color: #5a67d8; outline: none; }
        
        /* ========== æŒ‰é’®æ ·å¼ ========== */
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); 
        }
        button.secondary { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); }
        button.warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        
        /* ========== è¡¨æ ¼æ ·å¼ ========== */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f7fafc; font-weight: 600; color: #4a5568; }
        tr:hover { background: #f7fafc; }
        .category-input { width: 100%; min-width: 80px; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; }
        .category-input:focus { border-color: #5a67d8; outline: none; }
        .market-select { width: 100%; min-width: 72px; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; cursor: pointer; }
        .market-select:focus { border-color: #5a67d8; outline: none; }
        
        /* ========== æ­¥éª¤æŒ‡ç¤ºå™¨æ ·å¼ ========== */
        .steps { 
            display: flex; 
            justify-content: center; 
            gap: 0; 
            margin-bottom: 25px; 
        }
        .step { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 15px 25px; 
            background: rgba(255,255,255,0.2); 
            color: white; 
            position: relative; 
        }
        .step:first-child { border-radius: 25px 0 0 25px; }
        .step:last-child { border-radius: 0 25px 25px 0; }
        .step.active { background: white; color: #5a67d8; }
        .step.completed { background: rgba(56, 178, 172, 0.9); }
        .step-num { 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            background: currentColor; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
        }
        .step.active .step-num { background: #5a67d8; color: white; }
        .step.completed .step-num { background: white; color: #38b2ac; }
        
        /* ========== æ±‡æ€»å¡ç‰‡æ ·å¼ ========== */
        .summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        .summary-item { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center; 
            color: white; 
        }
        .summary-item .value { font-size: 28px; font-weight: bold; }
        .summary-item .label { opacity: 0.9; margin-top: 5px; font-size: 14px; }
        
        /* ========== è¡Œä¸šåˆ†æå›¾è¡¨æ ·å¼ ========== */
        .industry-chart { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .industry-bar { margin-bottom: 12px; }
        .industry-bar .label { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 14px; 
        }
        .industry-bar .bar { 
            height: 24px; 
            border-radius: 12px; 
            background: #e2e8f0; 
            overflow: hidden; 
        }
        .industry-bar .fill { 
            height: 100%; 
            border-radius: 12px; 
            transition: width 0.5s; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            padding-right: 8px; 
            color: #fff; 
            font-size: 12px; 
            font-weight: bold; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* ========== äº§å“æ ‡ç­¾é¡µæ ·å¼ ========== */
        .tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .tab { 
            padding: 10px 20px; 
            background: #e2e8f0; 
            border-radius: 8px 8px 0 0; 
            cursor: pointer; 
            font-weight: 600; 
            color: #4a5568; 
            transition: all 0.3s; 
        }
        .tab:hover { background: #cbd5e0; }
        .tab.active { background: #5a67d8; color: white; }
        
        /* ========== æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ ========== */
        .upload-area { 
            border: 3px dashed #cbd5e0; 
            border-radius: 12px; 
            padding: 40px; 
            text-align: center; 
            transition: all 0.3s; 
            cursor: pointer; 
        }
        .upload-area:hover { border-color: #5a67d8; background: #f7fafc; }
        .upload-area .icon { font-size: 48px; margin-bottom: 10px; }
        .upload-area input { display: none; }
        
        /* ========== å›¾ç‰‡é¢„è§ˆç½‘æ ¼æ ·å¼ ========== */
        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .image-item { 
            position: relative; 
            border-radius: 8px; 
            overflow: hidden; 
            cursor: pointer; 
        }
        .image-item img { width: 100%; height: 120px; object-fit: cover; }
        .image-item .name { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            padding: 5px; 
            font-size: 12px; 
            text-overflow: ellipsis; 
            overflow: hidden;
            white-space: nowrap; 
        }
        
        /* ========== æç¤ºæ¡†æ ·å¼ ========== */
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; }
        .alert-info { background: #ebf8ff; border-left: 4px solid #4299e1; color: #2b6cb0; }
        .alert-success { background: #f0fff4; border-left: 4px solid #48bb78; color: #276749; }
        
        /* ========== è¡Œä¸šåˆ†ç±»æ ‡ç­¾æ ·å¼ï¼ˆå„è¡Œä¸šå¯¹åº”ä¸åŒé¢œè‰²ï¼‰ ========== */
        .cat-tag { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
        }
        .cat-ç¾å›½åŠå¯¼ä½“ { background: #fed7d7; color: #c53030; }
        .cat-Aè‚¡åŠå¯¼ä½“ { background: #feebc8; color: #c05621; }
        .cat-æ¸¯è‚¡FAB { background: #e9d8fd; color: #6b46c1; }
        .cat-ç¾å›½ç®—åŠ› { background: #fefcbf; color: #975a16; }
        .cat-Aè‚¡ç®—åŠ› { background: #bee3f8; color: #2b6cb0; }
        .cat-Aè‚¡èµ„æº { background: #c6f6d5; color: #276749; }
        .cat-æ¸¯è‚¡èµ„æº { background: #b2f5ea; color: #234e52; }
        .cat-Aè‚¡é”‚ç”µå…‰ä¼ { background: #faf089; color: #744210; }
        .cat-äº’è”ç½‘ { background: #c4f1f9; color: #086f83; }
        
        /* ========== å›¾ç‰‡æŸ¥çœ‹å™¨ï¼ˆå…¨å±é¢„è§ˆï¼‰ ========== */
        .viewer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: none; 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
        }
        .viewer img { max-width: 95%; max-height: 95%;}
        .viewer .close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }

        /* ========== OCRç›¸å…³æ ·å¼ ========== */
        .ocr-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .ocr-input {
            flex: 1;
            min-width: 200px;
        }
        .ocr-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
        }
        .ocr-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        .ocr-input input:focus {
            border-color: #5a67d8;
            outline: none;
        }
        .ocr-progress {
            display: none;
            padding: 10px;
            background: #ebf8ff;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #2b6cb0;
        }
        .ocr-progress.active {
            display: block;
        }
        .ocr-result {
            display: none;
            padding: 15px;
            background: #f0fff4;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #48bb78;
        }
        .ocr-result.active {
            display: block;
        }
        .ocr-result pre {
            background: white;
            padding: 10px;
            border-radius: 6px;
            max-height: 200px;
            overflow: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .ocr-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .ocr-btn-recognize {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .ocr-btn-recognize:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        /* ========== è¡Œä¸šæŸ±çŠ¶å›¾ï¼šé¢„è®¾ç±»åé¢œè‰²ï¼ˆå¤‡ç”¨ï¼‰ ========== */
        .ind-ç¾å›½åŠå¯¼ä½“ { background: linear-gradient(90deg, #dc2626, #b91c1c); }
        .ind-Aè‚¡åŠå¯¼ä½“ { background: linear-gradient(90deg, #ea580c, #c2410c); }
        .ind-æ¸¯è‚¡FAB { background: linear-gradient(90deg, #7c3aed, #6d28d9); }
        .ind-ç¾å›½ç®—åŠ› { background: linear-gradient(90deg, #ca8a04, #a16207); }
        .ind-Aè‚¡ç®—åŠ› { background: linear-gradient(90deg, #2563eb, #1d4ed8); }
        .ind-Aè‚¡èµ„æº { background: linear-gradient(90deg, #059669, #047857); }
        .ind-æ¸¯è‚¡èµ„æº { background: linear-gradient(90deg, #0d9488, #0f766e); }
        .ind-Aè‚¡é”‚ç”µå…‰ä¼ { background: linear-gradient(90deg, #d97706, #b45309); }
        .ind-äº’è”ç½‘ { background: linear-gradient(90deg, #0891b2, #0e7490); }
        
        /* ========== å¸‚åœºå æ¯”é¥¼å›¾ ========== */
        .market-pie-wrap { display: flex; align-items: center; gap: 24px; flex-wrap: wrap; margin-bottom: 20px; }
        .market-pie-chart { width: 180px; height: 180px; border-radius: 50%; flex-shrink: 0; }
        .market-pie-legend { display: flex; flex-direction: column; gap: 8px; }
        .market-pie-legend span { display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .market-pie-legend .dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        
        /* ========== å“åº”å¼å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰ ========== */
        @media (max-width: 768px) {
            .industry-chart { grid-template-columns: 1fr; }
            .steps { flex-wrap: wrap; }
            .step { border-radius: 8px !important; margin: 2px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æŒä»“æ•´ç†å·¥å…· v1.1</h1>
        
        <!-- ========== æ­¥éª¤æŒ‡ç¤ºå™¨ ========== -->
        <div class="steps">
            <div class="step active" id="step1"><span class="step-num">1</span> ä¸Šä¼ æˆªå›¾</div>
            <div class="step" id="step2"><span class="step-num">2</span> è¾“å…¥ç°é‡‘ & å¯¼å…¥æ•°æ®</div>
            <div class="step" id="step3"><span class="step-num">3</span> æŸ¥çœ‹ç»“æœ</div>
        </div>

        <!-- ========== æ­¥éª¤1ï¼šä¸Šä¼ æˆªå›¾åŒºåŸŸ ========== -->
        <div class="card" id="card1">
            <h2>ğŸ“· ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æŒä»“æˆªå›¾</h2>

            <!-- OCR å¼•æ“ï¼šMiniMax / Gemini / OpenAIï¼Œé€‰ Gemini æˆ– OpenAI æ—¶å¯å¡«å†™ API Key -->
            <div class="ocr-controls" style="margin-bottom:12px;">
                <div class="ocr-input">
                    <label>OCR å¼•æ“</label>
                    <select id="ocrProvider" onchange="toggleOcrKeyBlocks()" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;">
                        <option value="minimax">MiniMax å›½é™…ç«™</option>
                        <option value="gemini">Gemini (1.5 Flash)</option>
                        <option value="openai">OpenAI (GPT-4o mini)</option>
                    </select>
                </div>
                <div class="ocr-input" id="geminiKeyBlock" style="display:none;">
                    <label>Gemini API Keyï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ç”¨åç«¯é»˜è®¤ï¼‰</label>
                    <input type="password" id="geminiApiKey" placeholder="AIza... ä¸å¡«åˆ™ç”¨æœåŠ¡ç«¯é…ç½®">
                </div>
                <div class="ocr-input" id="openaiKeyBlock" style="display:none;">
                    <label>OpenAI API Keyï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ç”¨æœåŠ¡ç«¯å·²é…ç½®çš„ Keyï¼‰</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-... ä¸å¡«åˆ™ç”¨æœåŠ¡ç«¯é…ç½®">
                </div>
            </div>

            <!-- OCRè¿›åº¦æç¤º -->
            <div class="ocr-progress" id="ocrProgress">
                æ­£åœ¨è¿›è¡ŒOCRè¯†åˆ«ï¼Œè¯·ç¨å€™...
            </div>

            <!-- OCRè¯†åˆ«ç»“æœï¼ˆéšè—ï¼Œè‡ªåŠ¨ä½¿ç”¨ï¼‰ -->
            <div class="ocr-result" id="ocrResult" style="display:none;"></div>

            <div class="alert alert-info">
                <strong>ğŸ’¡ ä½¿ç”¨æµç¨‹ï¼š</strong> ä¸Šä¼ æˆªå›¾ï¼ˆGT/TRS å‡å¯ï¼Œè‡ªåŠ¨è¯†åˆ«ï¼‰â†’ ç‚¹å‡»ã€Œå¼€å§‹è®¡ç®—ã€
            </div>

            <div class="form-group">
                <label>ä¸Šä¼ æˆªå›¾</label>
                <div class="upload-area" onclick="document.getElementById('screenshotInput').click()">
                    <input type="file" id="screenshotInput" multiple accept="image/*" onchange="handleUploadAsync(event)">
                    <div class="icon">ğŸ“¤</div>
                    <div>ç‚¹å‡»ä¸Šä¼ æˆªå›¾ï¼ˆGT / TRS å‡å¯ï¼Œè‡ªåŠ¨è¯†åˆ«è¡¨å¤´å¹¶æ±‡æ€»ï¼‰</div>
                </div>
                <div class="image-grid" id="screenshotGrid"></div>
            </div>

            <div style="text-align:center;margin-top:20px;">
                <button onclick="startCalculation()" style="font-size:18px;padding:15px 40px;">ğŸš€ å¼€å§‹è®¡ç®—</button>
            </div>
        </div>

        <!-- ========== æ­¥éª¤2ï¼šè¾“å…¥ç°é‡‘ & å¯¼å…¥æ•°æ® ========== -->
        <div class="card" id="card2">
            <h2>ğŸ’° ç¬¬äºŒæ­¥ï¼šè¾“å…¥ç°é‡‘ & å¯¼å…¥æ•°æ®</h2>
            
            <!-- å„äº§å“ç°é‡‘è¾“å…¥æ¡† -->
            <div class="form-row">
                <div class="form-group">
                    <label>1å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash1" value="3" step="0.01" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>2å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash2" value="140" step="0.01" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>5å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash5" value="9" step="0.01" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>6å·äº§å“ç°é‡‘(ä¸‡å…ƒ)</label>
                    <input type="number" id="cash6" value="59" step="0.01" onchange="calculate()">
                </div>
            </div>
            
            <!-- éšè—çš„CSVæ–‡ä»¶è¾“å…¥æ¡†ï¼ˆä¾›åå°é€»è¾‘ä½¿ç”¨ï¼‰ -->
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSV(event)">
        </div>

        <!-- ========== æ­¥éª¤3ï¼šæŸ¥çœ‹ç»“æœ ========== -->
        <div class="card" id="card3">
            <h2>ğŸ“ˆ ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹ç»“æœ</h2>
            
            <!-- æ€»ä½“æ±‡æ€»ç»Ÿè®¡ -->
            <h3 style="color:#5a67d8;margin-bottom:15px;">ğŸ’¼ æ‰€æœ‰äº§å“æ±‡æ€»</h3>
            <div class="summary" id="summary">
                <div class="summary-item">
                    <div class="value" id="totalAssets">0</div>
                    <div class="label">æ€»èµ„äº§(ä¸‡å…ƒäººæ°‘å¸)</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="totalMarket">0</div>
                    <div class="label">å¸‚å€¼åˆè®¡(ä¸‡å…ƒäººæ°‘å¸)</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="totalCash">0</div>
                    <div class="label">ç°é‡‘åˆè®¡(ä¸‡å…ƒäººæ°‘å¸)</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="stockCount">0</div>
                    <div class="label">æŒä»“æ•°é‡</div>
                </div>
            </div>
            <p id="rateHint" style="margin-top:8px;font-size:12px;color:#718096;"></p>
            
            <!-- å¸‚åœºå æ¯”é¥¼å›¾ -->
            <h3 style="color:#5a67d8;margin:25px 0 15px;">ğŸ“ˆ å¸‚åœºå æ¯”</h3>
            <div id="marketPieWrap" class="market-pie-wrap"></div>
            
            <!-- è¡Œä¸šå æ¯”åˆ†æåŒºåŸŸ -->
            <h3 style="color:#5a67d8;margin:25px 0 15px;">ğŸ“Š è¡Œä¸šå æ¯”åˆ†æ</h3>
            <div class="industry-chart">
                <div id="industryBars"></div>  <!-- æŸ±çŠ¶å›¾ -->
                <div id="industryTable"></div> <!-- æ˜ç»†è¡¨æ ¼ -->
            </div>
            
            <!-- åˆ†äº§å“æŒä»“æ˜ç»† -->
            <h3 style="color:#5a67d8;margin:25px 0 15px;">ğŸ“‹ åˆ†äº§å“æŒä»“æ˜ç»†</h3>
            
            <!-- äº§å“æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('1å·')">1å·äº§å“</div>
                <div class="tab" onclick="switchTab('2å·')">2å·äº§å“</div>
                <div class="tab" onclick="switchTab('5å·')">5å·äº§å“</div>
                <div class="tab" onclick="switchTab('6å·')">6å·äº§å“</div>
                <div class="tab" onclick="switchTab('all')">å…¨éƒ¨æ±‡æ€»</div>
            </div>
            
            <!-- æŒä»“æ˜ç»†è¡¨æ ¼å®¹å™¨ -->
            <div id="holdingsTable"></div>
        </div>
    </div>

    <!-- ========== å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨ ========== -->
    <div class="viewer" id="viewer" onclick="closeViewer()">
        <span class="close">&times;</span>
        <img id="viewerImg" src="">
    </div>

    <script>
        // ================================================================
        // å…¨å±€å˜é‡å®šä¹‰
        // ================================================================
        
        /**
         * æŒä»“æ•°æ®æ•°ç»„
         * æ¯æ¡è®°å½•æ ¼å¼: { product: '1å·', stock: 'ä¸‡é‡ŒçŸ³', value: 4115.10, category: 'Aè‚¡èµ„æº' }
         */
        let holdings = [];
        
        /**
         * å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µ
         * å¯é€‰å€¼: '1å·', '2å·', '5å·', '6å·', 'all'
         */
        let currentTab = '1å·';
        
        /**
         * ä¸Šä¼ çš„æˆªå›¾æ•°ç»„
         * æ ¼å¼: { name: 'æ–‡ä»¶å', src: 'base64ç¼–ç çš„å›¾ç‰‡æ•°æ®' }
         */
        let screenshotImages = [];   // ä¸Šä¼ çš„æˆªå›¾ï¼ˆGT/TRS æ··åˆï¼Œè§£ææ—¶æŒ‰è¡¨å¤´è‡ªåŠ¨è¯†åˆ«ï¼‰

        /**
         * OCRè¯†åˆ«ç»“æœç¼“å­˜
         */
        let ocrHoldings = [];  // OCRè¯†åˆ«åˆ°çš„æŒä»“æ•°æ®
        let currentRecognizingIndex = 0;  // å½“å‰æ­£åœ¨è¯†åˆ«çš„å›¾ç‰‡ç´¢å¼•
        let allImagesForOCR = [];  // æ‰€æœ‰éœ€è¦è¯†åˆ«çš„å›¾ç‰‡æ•°ç»„

        /** OCR åç«¯åœ°å€ï¼šåŒåŸŸåï¼ˆå«å…¬ç½‘éƒ¨ç½²ï¼‰ç”¨ç©ºï¼›æœ¬æœºç”¨å…¶ä»–ç«¯å£æ‰“å¼€é¡µé¢æ—¶æŒ‡å‘ 3011 */
        const OCR_BASE_URL = (window.location.hostname === 'localhost' && window.location.port !== '3011') ? 'http://localhost:3011' : '';
        // TRS æ±‡æ€»ç»Ÿä¸€ä¸ºäººæ°‘å¸(ä¸‡å…ƒ)ï¼šæ¸¯è‚¡(æ¸¯å…ƒ)ã€ç¾è‚¡(ç¾å…ƒ)æŒ‰å®æ—¶æ±‡ç‡æ¢ç®—ï¼Œè®¡ç®—å‰æ‹‰å–
        let RATE_USD_CNY = 7.24;
        let RATE_HKD_CNY = 0.92;

        /**
         * æ‹‰å–å®æ—¶æ±‡ç‡ï¼ˆç¾å…ƒ/æ¸¯å¸ â†’ äººæ°‘å¸ï¼‰ï¼Œå¤±è´¥æ—¶ä¿ç•™å½“å‰å€¼
         * ä½¿ç”¨ open.er-api.com å…è´¹æ¥å£ï¼ˆæ— éœ€ keyï¼‰
         */
        async function fetchExchangeRates() {
            try {
                const r = await fetch('https://open.er-api.com/v6/latest/USD');
                if (!r.ok) return;
                const j = await r.json();
                if (j.rates && j.rates.CNY != null && j.rates.HKD != null && j.rates.HKD > 0) {
                    RATE_USD_CNY = j.rates.CNY;
                    RATE_HKD_CNY = j.rates.CNY / j.rates.HKD;
                    return { usd: RATE_USD_CNY, hkd: RATE_HKD_CNY };
                }
            } catch (e) {
                console.warn('å®æ—¶æ±‡ç‡è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ±‡ç‡', e);
            }
            return null;
        }

        // ================================================================
        // åˆå§‹åŒ–ç›¸å…³
        // ================================================================

        // ================================================================
        // OCR è¯†åˆ«ï¼ˆä¸ image-to-excel ä¸€è‡´ï¼šä»…ä¼ å›¾ç‰‡ï¼ŒKey åç«¯å†…ç½®ï¼‰
        // ================================================================

        /**
         * æ£€æŸ¥ OCR æœåŠ¡æ˜¯å¦ä¸ºæ–°ç‰ˆï¼ˆé¿å…è¿åˆ°æ—§ç‰ˆåç«¯ï¼‰
         */
        async function checkOcrService() {
            try {
                const r = await fetch(`${OCR_BASE_URL}/api/version`);
                if (!r.ok) throw new Error('version check failed');
                const data = await r.json();
                if (data.version < 2) throw new Error('è¯·ä½¿ç”¨æ–°ç‰ˆ server.jsï¼ˆæ”¯æŒ version 2+ï¼‰');
                return true;
            } catch (e) {
                throw new Error('æ— æ³•è¿æ¥æœ¬åœ°æœåŠ¡ã€‚\n\nè‹¥å·²åŒå‡»æ¡Œé¢ã€Œportfolio-manager.exeã€å¯åŠ¨ï¼Œè¯·ç¨ç­‰å‡ ç§’åæŒ‰ Ctrl+F5 åˆ·æ–°æœ¬é¡µã€‚\n\nå¦åˆ™è¯·å…ˆå¯åŠ¨æœåŠ¡ï¼šåœ¨æœ¬æœºæ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥é¡¹ç›®ç›®å½•ï¼Œæ‰§è¡Œ node server.jsï¼Œç­‰å‡ºç°ã€Œç«¯å£: 3011ã€åå†åˆ·æ–°æœ¬é¡µã€‚');
            }
        }

        /**
         * è¯·æ±‚é€šçŸ¥æƒé™å¹¶å¼¹å‡ºæµè§ˆå™¨ç³»ç»Ÿé€šçŸ¥ï¼ˆOCR å®Œæˆåæç¤ºï¼‰
         */
        function showOcrCompleteNotification() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification('æŒä»“æ•´ç†å·¥å…·', { body: 'æ•°æ®è¯»å–å®Œæ¯•', icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2348bb78"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' });
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') new Notification('æŒä»“æ•´ç†å·¥å…·', { body: 'æ•°æ®è¯»å–å®Œæ¯•', icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2348bb78"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' });
                });
            }
        }

        /**
         * å¼€å§‹è®¡ç®—ï¼šä¸Šä¼ æˆªå›¾ â†’ OCR â†’ è§£æ â†’ è®¡ç®—æ±‡æ€»
         * @param {Object} [opts] - { thenExportExcel: true } è¡¨ç¤ºè¯†åˆ«å®Œæˆåç›´æ¥å¯¼å‡º Excel
         */
        async function startCalculation() {
            if (screenshotImages.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æŒä»“æˆªå›¾ï¼');
                return;
            }

            try {
                await checkOcrService();
            } catch (e) {
                alert(e.message);
                return;
            }

            document.getElementById('ocrProgress').classList.add('active');
            document.getElementById('ocrProgress').textContent = 'æ­£åœ¨è·å–å®æ—¶æ±‡ç‡...';
            await fetchExchangeRates();
            const rateHint = document.getElementById('rateHint');
            if (rateHint) rateHint.textContent = `æ±‡ç‡: 1ç¾å…ƒâ‰ˆ${RATE_USD_CNY.toFixed(2)}å…ƒ 1æ¸¯å¸â‰ˆ${RATE_HKD_CNY.toFixed(2)}å…ƒ`;

            allImagesForOCR = screenshotImages.map(img => ({ ...img, type: 'auto' }));
            ocrHoldings = [];

            for (let i = 0; i < allImagesForOCR.length; i++) {
                const img = allImagesForOCR[i];
                document.getElementById('ocrProgress').textContent =
                    `æ­£åœ¨è¯†åˆ« (${i + 1}/${allImagesForOCR.length}): ${img.name}...`;
                try {
                    const result = await recognizeImage(img.src);
                    const parsed = parseOCRResult(result, 'auto');
                    ocrHoldings.push(...parsed);
                } catch (error) {
                    console.error(`è¯†åˆ«å¤±è´¥: ${img.name}`, error);
                    document.getElementById('ocrProgress').classList.remove('active');
                    alert(`è¯†åˆ«å¤±è´¥: ${img.name}\n${error.message || 'OCRè¯†åˆ«å¤±è´¥'}`);
                    return;
                }
            }

            document.getElementById('ocrProgress').classList.remove('active');
            if (ocrHoldings.length === 0) {
                alert('æœªè¯†åˆ«åˆ°æŒä»“æ•°æ®ï¼Œè¯·æ£€æŸ¥æˆªå›¾è´¨é‡æˆ–å°è¯•æ‰‹åŠ¨å¯¼å…¥ã€‚\n\nè‹¥æˆªå›¾ä¸ºè¡¨æ ¼ï¼Œè¯·ç¡®ä¿æ¯è¡Œæ ¼å¼ä¸ºï¼šè‚¡ç¥¨åç§° + ç©ºæ ¼/åˆ¶è¡¨ç¬¦ + å¸‚å€¼æ•°å­—ã€‚\næŒ‰ F12 æ‰“å¼€æ§åˆ¶å°å¯æŸ¥çœ‹æœ¬æ¬¡è¯†åˆ«çš„åŸå§‹æ–‡æœ¬ã€‚');
                return;
            }

            holdings = [...ocrHoldings];
            // 1å·äº§å“åŒä¸€è‚¡ç¥¨å¯èƒ½åˆ†å¸ƒåœ¨ä¸¤ä¸ªè´¦æˆ·ï¼ŒæŒ‰è‚¡ç¥¨åç§°åŠ æ€»å¸‚å€¼
            const oneNo = holdings.filter(h => h.product === '1å·');
            const others = holdings.filter(h => h.product !== '1å·');
            const merged1 = [];
            const byStock = {};
            oneNo.forEach(h => {
                if (!byStock[h.stock]) byStock[h.stock] = { stock: h.stock, value: 0, category: h.category, marketOverride: h.marketOverride, exchange: h.exchange };
                byStock[h.stock].value += h.value;
            });
            Object.values(byStock).forEach(o => merged1.push({ product: '1å·', stock: o.stock, value: o.value, category: o.category, marketOverride: o.marketOverride, exchange: o.exchange }));
            holdings = [...merged1, ...others];
            calculate();

            showOcrCompleteNotification();

            document.getElementById('card2').scrollIntoView({ behavior: 'smooth' });
            alert(`è®¡ç®—å®Œæˆï¼æˆåŠŸå¯¼å…¥ ${ocrHoldings.length} æ¡æŒä»“æ•°æ®`);
        }

        function toggleOcrKeyBlocks() {
            const p = document.getElementById('ocrProvider').value;
            document.getElementById('geminiKeyBlock').style.display = p === 'gemini' ? 'block' : 'none';
            document.getElementById('openaiKeyBlock').style.display = p === 'openai' ? 'block' : 'none';
        }

        /**
         * è¯†åˆ«å•å¼ å›¾ç‰‡ï¼ˆæ”¯æŒ MiniMax / Gemini / OpenAIï¼ŒæŒ‰å½“å‰é€‰æ‹©çš„å¼•æ“ä¼ å‚ï¼‰
         */
        async function recognizeImage(image) {
            const provider = document.getElementById('ocrProvider').value;
            const body = { image, provider };
            if (provider === 'gemini') {
                const key = document.getElementById('geminiApiKey').value.trim();
                if (key) body.apiKey = key;
            } else if (provider === 'openai') {
                const key = document.getElementById('openaiApiKey').value.trim();
                if (key) body.apiKey = key;
            }
            let response;
            try {
                response = await fetch(`${OCR_BASE_URL}/api/ocr`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            } catch (e) {
                const msg = (e && e.message) || String(e);
                if (msg.includes('Failed to fetch') || msg.includes('NetworkError') || msg.includes('load failed')) {
                    throw new Error('æ— æ³•è¿æ¥ OCR æœåŠ¡ï¼Œè¯·ç¡®è®¤å·²å¯åŠ¨ server.jsï¼ˆç«¯å£ 3011ï¼‰');
                }
                throw e;
            }
            if (!response.ok) {
                let errorMsg = 'OCRè¯†åˆ«å¤±è´¥';
                try {
                    const errBody = await response.json();
                    errorMsg = errBody.error || errorMsg;
                } catch (_) {}
                throw new Error(errorMsg);
            }
            const result = await response.json();
            return result.data;
        }

        /**
         * è§£æOCRè¯†åˆ«ç»“æœï¼Œä»è¯†åˆ«æ–‡æœ¬ä¸­æå–æŒä»“ï¼ˆäº§å“ã€åç§°ã€å¸‚å€¼ï¼‰ã€‚
         * - TRSï¼šè¡¨å¤´ è´¦æˆ·åç§°/æ ‡çš„åç§°/æŒä»“å¸‚å€¼ ç­‰ï¼Œæ•°æ®è¡Œä¸è¡¨å¤´åˆ—å¯¹é½ï¼ŒæŒä»“å¸‚å€¼ä¸ºå…ƒ(Ã·10000)ã€‚
         * - GTï¼šè¡¨å¤´ äº§å“åç§°/å¸‚å€¼/åç§° ç­‰ï¼ŒOCR å¸¸åœ¨æ•°æ®è¡Œå‰å¤šä¸€åˆ—è¡Œå·(1/2/3â€¦)ï¼Œè§£ææ—¶ç”¨ rowOffset å¯¹é½ã€‚
         * @param {Object} ocrData - OCR è¿”å›ï¼Œå¦‚ { content: "..." }
         * @param {string} type - 'auto'
         * @returns {Array} { product, stock, value, category }[]
         */
        function parseOCRResult(ocrData, type) {
            const holdings = [];

            try {
                // OCR è¿”å›ä¸ image-to-excel ä¸€è‡´ï¼šdata.content ä¸ºè¯†åˆ«æ–‡æœ¬ï¼ˆMiniMaxï¼‰
                let text = '';
                if (ocrData.content) {
                    text = String(ocrData.content);
                } else if (ocrData.words_result && Array.isArray(ocrData.words_result)) {
                    text = ocrData.words_result.map(w => w.words || '').join('\n');
                } else if (ocrData.text) {
                    text = String(ocrData.text);
                } else if (ocrData.data && ocrData.data.content) {
                    text = String(ocrData.data.content);
                } else {
                    text = typeof ocrData === 'string' ? ocrData : JSON.stringify(ocrData);
                }
                // è‹¥ä¸º Markdown è¡¨æ ¼ï¼ˆ| åˆ†éš”ï¼‰ï¼Œå…ˆè½¬ä¸º Tab åˆ†éš”ä¾¿äºç»Ÿä¸€è§£æ
                if (text.includes('|') && text.includes('\n')) {
                    text = text.split(/\r?\n/).map(l => {
                        const t = l.trim();
                        if (!t || !t.includes('|')) return t;
                        return t.replace(/\|\s*/g, '\t').replace(/^\t|\t$/g, '');
                    }).join('\n');
                }

                // è§£ææŒä»“ä¿¡æ¯ï¼šæ”¯æŒã€Œè‚¡ç¥¨ å¸‚å€¼ã€ã€Tab åˆ†éš”ã€äº§å“è¡Œç­‰
                const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                let currentProduct = '1å·';

                // å¤šåˆ—è¡¨æ ¼ï¼šæ ¹æ®è¡¨å¤´åŠ¨æ€è¯†åˆ«åç§°/ä»£ç /å¸‚å€¼/äº¤æ˜“æ‰€åˆ—ï¼ˆå…¼å®¹ GT ä¸ TRSï¼‰
                let idxName = 3, idxCode = 2, idxValue = 11, idxProduct = -1, idxExchange = -1, valueColumnInYuan = true, headerDetected = false;
                const detectHeader = (parts) => {
                    const nameKeys = ['æ ‡çš„åç§°', 'è‚¡ç¥¨åç§°', 'åç§°', 'å ç§°', 'ä¸‰ä¸€åç§°'];
                    const codeKeys = ['æ ‡çš„ä»£ç ', 'ä»£ç '];
                    const productKeys = ['äº§å“åç§°', 'äº§å“', 'è´¦æˆ·åç§°'];
                    const exchangeKeys = ['äº¤æ˜“æ‰€', 'äº¤æ˜“å“ç§'];
                    const valKeysYuan = ['æŒä»“å¸‚å€¼'];
                    const valKeys = ['æŒä»“å¸‚å€¼', 'å¸‚å€¼', 'å¸‚å€¼(ä¸‡)', 'å¸‚å€¼ï¼ˆä¸‡ï¼‰', 'å¸‚ å€¼'];
                    let iName = parts.findIndex(p => nameKeys.includes(String(p).trim()));
                    if (iName < 0) iName = parts.findIndex(p => /åç§°/.test(String(p)));
                    const iCode = parts.findIndex(p => codeKeys.includes(String(p).trim()));
                    const iVal = parts.findIndex(p => valKeys.includes(String(p).trim()));
                    const iProd = parts.findIndex(p => productKeys.includes(String(p).trim()));
                    const iEx = parts.findIndex(p => exchangeKeys.includes(String(p).trim()));
                    if (iName >= 0 && iVal >= 0) {
                        idxName = iName; idxValue = iVal;
                        if (iCode >= 0) idxCode = iCode;
                        if (iProd >= 0) idxProduct = iProd;
                        if (iEx >= 0) idxExchange = iEx;
                        valueColumnInYuan = valKeysYuan.includes(parts[iVal]) || (iProd >= 0 && parts[iVal] === 'å¸‚å€¼');
                        headerDetected = true;
                        return true;
                    }
                    return false;
                };
                const toWanCNY = (valueLocal, exchangeCell) => {
                    const s = String(exchangeCell || '').trim();
                    if (/æ¸¯äº¤æ‰€|æ¸¯è‚¡/.test(s)) return (valueLocal * RATE_HKD_CNY) / 10000;
                    if (/çº³äº¤æ‰€|çº½äº¤æ‰€|ç¾è‚¡/.test(s)) return (valueLocal * RATE_USD_CNY) / 10000;
                    return valueLocal / 10000;
                };
                const parseProductFromCell = (cell) => {
                    if (cell == null || String(cell).trim() === '') return null;
                    const s = String(cell).trim();
                    const m1 = s.match(/(\då·)/);
                    if (m1) return m1[1];
                    const m2 = s.match(/(\d)\s*å·?/);
                    if (m2) return m2[1] + 'å·';
                    return null;
                };
                const isGTProductCell = (p) => /æ±‡å®½å¤©ç¿¼/.test(String(p)) && /\d/.test(String(p));

                lines.forEach(line => {
                    // å°è¯•åŒ¹é…äº§å“ç¼–å·ï¼š1å·äº§å“ã€äº§å“1å·ã€äº§å“1ã€æˆ–å•ç‹¬ä¸€è¡Œçš„ 1å·/2å·
                    const productMatch = line.match(/(\då·)äº§å“|äº§å“(\då·)|äº§å“(\d)|^(\då·)\s*$/);
                    if (productMatch) {
                        const raw = productMatch[1] || productMatch[2] || productMatch[4] || (productMatch[3] ? productMatch[3] + 'å·' : '');
                        currentProduct = (raw || '').trim() || currentProduct;
                        return;
                    }

                    let stock = '';
                    let value = NaN;
                    let exchangeCell = '';

                    // ç»Ÿä¸€æŒ‰ã€Œåˆ—ã€è§£æï¼šTab æˆ– ç©ºæ ¼åˆ†åˆ—ï¼ˆGT è¡¨ OCR å¸¸ä¸ºå•ç©ºæ ¼ï¼ŒTRS å¸¸ä¸º Tabï¼‰
                    const parts = line.includes('\t')
                        ? line.split('\t').map(p => p.trim())
                        : line.split(/\s+/).map(p => p.trim()).filter(Boolean);

                    if (parts.length >= 2) {
                        if (detectHeader(parts)) return;
                        const canUseDetectedColumns = headerDetected && parts.length > idxValue && (parts[idxName] != null);
                        if (parts.length >= 12 || canUseDetectedColumns) {
                            // ã€é‡è¦ã€‘OCR/GT è¡¨å¸¸åœ¨ç¬¬ä¸€åˆ—è¾“å‡ºè¡Œå·(1/2/3â€¦)ï¼Œè¡¨å¤´æ— æ­¤è¡Œå·ï¼Œå¯¼è‡´æ•°æ®è¡Œä¸è¡¨å¤´é”™ä½ä¸€åˆ—ã€‚
                            // è‹¥é¦–åˆ—ä¸ºçº¯æ•°å­—åˆ™è§†ä¸ºè¡Œå·ï¼Œåˆ—ä¸‹æ ‡æ•´ä½“ +1ï¼Œå¦åˆ™ä¸è¡¨å¤´å¯¹é½ã€‚
                            const rowOffset = (parts.length > idxValue + 1 && /^\d+$/.test(String(parts[0]).trim())) ? 1 : 0;
                            const colName = (parts[idxName + rowOffset] || '').trim();
                            const colCode = (parts[idxCode + rowOffset] != null ? parts[idxCode + rowOffset] : '').trim();
                            const colValue = parts[idxValue + rowOffset];
                            const isHeaderCell = ['æ ‡çš„åç§°','è‚¡ç¥¨åç§°','åç§°','å ç§°','ä¸‰ä¸€åç§°','æŒä»“å¸‚å€¼','å¸‚å€¼','å¸‚ å€¼','å¸‚å€¼(ä¸‡)','å¸‚å€¼ï¼ˆä¸‡ï¼‰','èµ„é‡‘è´¦å·','äº§å“åç§°','äº§å“','è´¦æˆ·åç§°','æŒä»“å‡€å€¼å æ¯”'].includes(colName) || ['æŒä»“å¸‚å€¼','å¸‚å€¼','å¸‚ å€¼'].includes(String(colValue));
                            if (colName && !isHeaderCell && colValue !== '' && colValue != null) {
                                let productFromRow = idxProduct >= 0 ? parseProductFromCell(parts[idxProduct + rowOffset]) : null;
                                if (!productFromRow) {
                                    for (let i = 0; i < parts.length; i++) {
                                        productFromRow = parseProductFromCell(parts[i]);
                                        if (productFromRow) break;
                                    }
                                }
                                if (productFromRow) currentProduct = productFromRow;
                                stock = (/^\d+$/.test(colName) && colCode && /[A-Za-z.]/.test(colCode)) ? colCode : colName;
                                if (idxExchange >= 0 && parts[idxExchange + rowOffset] != null) exchangeCell = String(parts[idxExchange + rowOffset]).trim();
                                const rawVal = parseFloat(String(colValue).replace(/,/g, '').replace(/[\s%]/g, ''));
                                if (idxExchange >= 0 && (valueColumnInYuan || rawVal > 100000)) {
                                    value = toWanCNY(rawVal, parts[idxExchange + rowOffset]);
                                } else if (valueColumnInYuan || rawVal > 100000) {
                                    value = rawVal / 10000;
                                } else {
                                    value = rawVal;
                                }
                            }
                        } else if (parts.length >= 5) {
                            // GT è¡¨å›é€€ï¼šä»»æ„è¡Œå«ã€Œæ±‡å®½å¤©ç¿¼+æ•°å­—ã€æˆ–ã€ŒXå·ã€åˆ™æŒ‰ äº§å“å, å¸‚å€¼, åç§° åˆ—åºè§£æï¼ˆæ— è¡¨å¤´æˆ–è¡¨å¤´æœªè¯†åˆ«æ—¶ï¼‰
                            const gtProductIdx = parts.findIndex(p => isGTProductCell(p));
                            const anyProductIdx = gtProductIdx >= 0 ? gtProductIdx : parts.findIndex(p => /^\då·$/.test(String(p).trim()));
                            const productColIdx = gtProductIdx >= 0 ? gtProductIdx : anyProductIdx;
                            if (productColIdx >= 0 && parts[productColIdx + 1] != null && parts[productColIdx + 2] != null) {
                                const idxV = productColIdx + 1, idxN = productColIdx + 2;
                                const nameCell = String(parts[idxN]).trim();
                                const valCell = String(parts[idxV]).replace(/,/g, '').replace(/[\s%]/g, '');
                                const numVal = parseFloat(valCell);
                                const skipNames = ['èµ„é‡‘è´¦å·','äº§å“åç§°','å¸‚å€¼','åç§°','å ç§°','å¸‚ å€¼','ä»£ç ','æŒä»“å‡€å€¼å æ¯”','å¯ç”¨æŒä»“','æŒä»“é‡','æœ€æ–°ä»·','æ˜¨æ—¥æŒä»“','åœ¨é€”','å†»ç»“','å½“æ—¥æ¶¨å¹…','ç›ˆäº','æˆæœ¬ä»·','ç›ˆäºæ¯”ä¾‹','çŠ¶æ€'];
                                if (nameCell && !/^[\d.%\s-]+$/.test(nameCell) && !skipNames.includes(nameCell) && !/^æ±‡å®½å¤©ç¿¼\då·?$/.test(nameCell) && !isNaN(numVal) && numVal > 0) {
                                    const prod = parseProductFromCell(parts[productColIdx]) || (String(parts[productColIdx]).match(/(\då·)/) || [])[1];
                                    if (prod) currentProduct = prod;
                                    stock = nameCell;
                                    value = numVal >= 10000 ? numVal / 10000 : numVal;
                                }
                            }
                        }
                        if (!stock && isNaN(value) && parts.length >= 2 && !headerDetected) {
                            if (['æ ‡çš„åç§°','è‚¡ç¥¨åç§°','åç§°','æŒä»“å¸‚å€¼','å¸‚å€¼'].includes(parts[0]) || ['æŒä»“å¸‚å€¼','å¸‚å€¼'].includes(parts[1])) return;
                            stock = parts[0];
                            value = parseFloat(String(parts[1]).replace(/,/g, '').replace(/[^\d.-]/g, ''));
                        }
                    }
                    // æ ¼å¼2: å•è¡Œ è‚¡ç¥¨åç§° æ•°å­—ï¼ˆæœªè¿›å…¥å¤šåˆ—åˆ†æ”¯æ—¶ï¼‰
                    if (!stock && isNaN(value)) {
                        const stockMatch = line.match(/^([\u4e00-\u9fa5A-Za-z0-9]+)\s+([\d.,]+)/);
                        if (stockMatch) {
                            stock = stockMatch[1];
                            value = parseFloat(stockMatch[2].replace(/,/g, ''));
                        }
                    }
                    if (!stock && isNaN(value)) {
                        const m = line.match(/^([\u4e00-\u9fa5A-Za-z0-9]+)\s+([\d.,]+)\s*ä¸‡?/);
                        if (m) { stock = m[1]; value = parseFloat(m[2].replace(/,/g, '')); }
                    }

                    if (stock && !isNaN(value) && value > 0) {
                        if (stock === 'åˆè®¡' || stock === 'ç°é‡‘' || /^äº§å“\d*$/.test(stock) || /^æ±‡å®½å¤©ç¿¼\då·?$/.test(stock)) return;
                        const preset = getStoredStockPreset(stock);
                        holdings.push({
                            product: currentProduct,
                            stock: stock,
                            value: value,
                            category: (preset && preset.category) ? preset.category : (categoryMap[stock] || 'Aè‚¡èµ„æº'),
                            exchange: exchangeCell || '',
                            marketOverride: (preset && preset.market) ? preset.market : undefined
                        });
                    }
                });

                if (holdings.length === 0) console.warn('è§£æåˆ° 0 æ¡æŒä»“ã€‚è¡Œæ•°:', lines.length, '| æ–‡æœ¬é•¿åº¦:', text.length, '| å‰800å­—:', text.slice(0, 800));

            } catch (error) {
                console.error('è§£æOCRç»“æœå¤±è´¥:', error);
            }

            return holdings;
        }

        // ================================================================
        // è¡Œä¸šåˆ†ç±»ä¸å¸‚åœºï¼ˆå«æ‰‹åŠ¨é¢„è®¾æŒä¹…åŒ–ï¼‰
        // ================================================================

        const PRESET_STORAGE_KEY = 'portfolio-stock-presets';

        /** è¯»å–æŸåªè‚¡ç¥¨çš„è®°å¿†ï¼š{ market, category }ï¼Œæ— åˆ™ null */
        function getStoredStockPreset(stock) {
            try {
                const raw = localStorage.getItem(PRESET_STORAGE_KEY);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                return obj[String(stock).trim()] || null;
            } catch (e) { return null; }
        }

        /** æ›´æ–°æŸåªè‚¡ç¥¨çš„è®°å¿†ï¼ˆåªæ›´æ–°ä¼ å…¥çš„å­—æ®µï¼Œå…¶ä½™ä¿ç•™ï¼‰ */
        function setStoredStockPreset(stock, partial) {
            const key = String(stock).trim();
            if (!key) return;
            try {
                const raw = localStorage.getItem(PRESET_STORAGE_KEY);
                const obj = raw ? JSON.parse(raw) : {};
                obj[key] = { ...(obj[key] || {}), ...partial };
                localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(obj));
            } catch (e) { console.warn('ä¿å­˜é¢„è®¾å¤±è´¥', e); }
        }

        /**
         * å¸‚åœºæ˜¾ç¤ºå€¼ï¼šä¼˜å…ˆç”¨æ‰‹åŠ¨è¦†ç›–ï¼Œå¦åˆ™æŒ‰äº¤æ˜“æ‰€/åç§°æ¨æ–­
         */
        function getMarket(h) {
            if (h.marketOverride) return h.marketOverride;
            const ex = (h.exchange || '').trim();
            if (ex && /æ¸¯äº¤æ‰€|æ¸¯è‚¡|é¦™æ¸¯/.test(ex)) return 'æ¸¯è‚¡';
            if (ex && /çº³äº¤æ‰€|çº½äº¤æ‰€|ç¾è‚¡|ç¾å›½/.test(ex)) return 'ç¾è‚¡';
            const s = (h.stock || '').trim();
            if (/\.HK$|æ¸¯è‚¡|é¦™æ¸¯/.test(s)) return 'æ¸¯è‚¡';
            if (/^[A-Za-z0-9.]{2,12}$/.test(s)) return 'ç¾è‚¡';
            return 'Aè‚¡';
        }

        /**
         * è‚¡ç¥¨åç§° â†’ è¡Œä¸šåˆ†ç±» æ˜ å°„è¡¨
         * ç”¨äºè‡ªåŠ¨è¯†åˆ«è‚¡ç¥¨æ‰€å±è¡Œä¸š
         */
        const categoryMap = {
            // ç¾å›½åŠå¯¼ä½“
            'åŠå¯¼ä½“ä¸‰å€åšå¤š': 'ç¾å›½åŠå¯¼ä½“', 
            'SOXL': 'ç¾å›½åŠå¯¼ä½“', 
            'è‹±ç‰¹å°”': 'ç¾å›½åŠå¯¼ä½“',
            'Direxion Daily Sem': 'ç¾å›½åŠå¯¼ä½“',
            
            // ç¾å›½ç®—åŠ›
            'Lumentumæ§è‚¡': 'ç¾å›½ç®—åŠ›',
            'LUMENTUM': 'ç¾å›½ç®—åŠ›',
            
            // Aè‚¡åŠå¯¼ä½“
            'åŠå¯¼ä½“è®¾å¤‡ETF': 'Aè‚¡åŠå¯¼ä½“', 
            'ä¸­å¾®å…¬å¸': 'Aè‚¡åŠå¯¼ä½“',
            
            // Aè‚¡ç®—åŠ›
            'æ¶¦æ³½ç§‘æŠ€': 'Aè‚¡ç®—åŠ›', 
            'èƒœå®ç§‘æŠ€': 'Aè‚¡ç®—åŠ›', 
            'æ–°æ˜“ç››': 'Aè‚¡ç®—åŠ›', 
            'ä¸­é™…æ—­åˆ›': 'Aè‚¡ç®—åŠ›',
            
            // Aè‚¡èµ„æº
            'ä¸‡é‡ŒçŸ³': 'Aè‚¡èµ„æº', 
            'åè”æ§è‚¡': 'Aè‚¡èµ„æº', 
            'ç››å±¯çŸ¿ä¸š': 'Aè‚¡èµ„æº', 
            'æ°ç‘è‚¡ä»½': 'Aè‚¡èµ„æº',
            
            // æ¸¯è‚¡èµ„æº
            'åŠ›å‹¤èµ„æº': 'æ¸¯è‚¡èµ„æº', 
            'ä¸­æ ¸å›½é™…': 'æ¸¯è‚¡èµ„æº',
            
            // Aè‚¡é”‚ç”µå…‰ä¼
            'å…ˆå¯¼æ™ºèƒ½': 'Aè‚¡é”‚ç”µå…‰ä¼',
            
            // æ¸¯è‚¡FAB
            'ä¸­èŠ¯å›½é™…': 'æ¸¯è‚¡FAB',
            
            // äº’è”ç½‘
            'è°·æ­ŒA': 'äº’è”ç½‘', 
            'GGLL': 'äº’è”ç½‘',
            '2å€åšå¤šGOOGL-Di': 'äº’è”ç½‘'
        };
        
        /**
         * è¡Œä¸šæ˜¾ç¤ºé¡ºåºï¼ˆç”¨äºæ’åºï¼‰
         */
        const industryOrder = [
            'Aè‚¡èµ„æº', 'Aè‚¡ç®—åŠ›', 'Aè‚¡åŠå¯¼ä½“', 
            'æ¸¯è‚¡FAB', 'æ¸¯è‚¡èµ„æº', 
            'ç¾å›½åŠå¯¼ä½“', 'ç¾å›½ç®—åŠ›', 
            'Aè‚¡é”‚ç”µå…‰ä¼', 'äº’è”ç½‘'
        ];

        // ================================================================
        // å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆåŠŸèƒ½
        // ================================================================

        /**
         * å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆåŒ…è£…å‡½æ•°ï¼‰
         */
        function handleUploadAsync(e) {
            handleUpload(e).catch(error => {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        /**
         * å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆç»Ÿä¸€å…¥å£ï¼šGT/TRS æˆªå›¾å‡å¯ï¼Œè¯†åˆ«æ—¶æŒ‰è¡¨å¤´è‡ªåŠ¨åˆ†è¾¨ï¼‰
         */
        async function handleUpload(e) {
            const files = e.target.files;
            const grid = document.getElementById('screenshotGrid');

            screenshotImages.length = 0;
            grid.innerHTML = '';

            for (let f of files) {
                const result = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = ev => resolve(ev.target.result);
                    reader.onerror = err => reject(err);
                    reader.readAsDataURL(f);
                });
                screenshotImages.push({ name: f.name, src: result });
                const div = document.createElement('div');
                div.className = 'image-item';
                div.innerHTML = `
                    <img src="${result}" onclick="openViewer('${result.replace(/'/g, "\\'")}')">
                    <div class="name">${f.name}</div>
                `;
                grid.appendChild(div);
            }
            updateSteps();
        }

        /**
         * æ‰“å¼€å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨
         * @param {string} src - å›¾ç‰‡çš„ base64 æ•°æ®
         */
        function openViewer(src) { 
            document.getElementById('viewerImg').src = src; 
            document.getElementById('viewer').style.display = 'flex'; 
        }
        
        /**
         * å…³é—­å›¾ç‰‡å…¨å±æŸ¥çœ‹å™¨
         */
        function closeViewer() { 
            document.getElementById('viewer').style.display = 'none'; 
        }

        // ================================================================
        // ç°é‡‘ç›¸å…³è®¡ç®—å‡½æ•°
        // ================================================================
        
        /**
         * è·å–æŒ‡å®šäº§å“çš„ç°é‡‘é‡‘é¢
         * @param {string} p - äº§å“ç¼–å·ï¼ˆå¦‚ '1å·', '2å·'ï¼‰
         * @returns {number} ç°é‡‘é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
         */
        function getCash(p) { 
            return parseFloat(document.getElementById('cash' + p.replace('å·','')).value) || 0; 
        }
        
        /**
         * è®¡ç®—æ‰€æœ‰äº§å“çš„ç°é‡‘æ€»é¢
         * @returns {number} ç°é‡‘æ€»é¢ï¼ˆä¸‡å…ƒï¼‰
         */
        function getTotalCash() { 
            return getCash('1å·') + getCash('2å·') + getCash('5å·') + getCash('6å·'); 
        }

        // ================================================================
        // æ ¸å¿ƒè®¡ç®—ä¸æ¸²æŸ“å‡½æ•°
        // ================================================================
        
        /**
         * ä¸»è®¡ç®—å‡½æ•°ï¼šè®¡ç®—å¹¶æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®
         * åœ¨æ•°æ®å˜åŒ–æ—¶è°ƒç”¨ï¼ˆå¯¼å…¥æ•°æ®ã€ä¿®æ”¹ç°é‡‘ç­‰ï¼‰
         */
        function calculate() {
            // è®¡ç®—æ€»å¸‚å€¼ï¼ˆæ‰€æœ‰æŒä»“çš„å¸‚å€¼ä¹‹å’Œï¼‰
            const totalMarket = holdings.reduce((sum, h) => sum + h.value, 0);
            
            // è·å–ç°é‡‘æ€»é¢
            const totalCash = getTotalCash();
            
            // è®¡ç®—æ€»èµ„äº§
            const totalAssets = totalMarket + totalCash;
            
            // æ›´æ–°æ±‡æ€»æ˜¾ç¤º
            document.getElementById('totalAssets').textContent = totalAssets.toFixed(2);
            document.getElementById('totalMarket').textContent = totalMarket.toFixed(2);
            document.getElementById('totalCash').textContent = totalCash.toFixed(2);
            document.getElementById('stockCount').textContent = holdings.length;
            
            // æ¸²æŸ“å¸‚åœºå æ¯”é¥¼å›¾
            renderMarketPie(totalAssets);
            // æ¸²æŸ“è¡Œä¸šå æ¯”åˆ†æ
            renderIndustry(totalAssets);
            
            // æ¸²æŸ“æŒä»“æ˜ç»†è¡¨æ ¼
            renderTable();
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            updateSteps();
        }

        /** è¡Œä¸šæŸ±çŠ¶å›¾é…è‰²ï¼ˆæŒ‰é¡ºåºå¾ªç¯ä½¿ç”¨ï¼Œæ·±è‰²é†’ç›®ï¼‰ */
        const INDUSTRY_PALETTE = [
            'linear-gradient(90deg, #2563eb, #1d4ed8)',
            'linear-gradient(90deg, #dc2626, #b91c1c)',
            'linear-gradient(90deg, #059669, #047857)',
            'linear-gradient(90deg, #7c3aed, #6d28d9)',
            'linear-gradient(90deg, #ea580c, #c2410c)',
            'linear-gradient(90deg, #0891b2, #0e7490)',
            'linear-gradient(90deg, #ca8a04, #a16207)',
            'linear-gradient(90deg, #0d9488, #0f766e)',
            'linear-gradient(90deg, #db2777, #be185d)',
            'linear-gradient(90deg, #4f46e5, #4338ca)'
        ];

        /**
         * æ¸²æŸ“å¸‚åœºå æ¯”é¥¼å›¾ï¼ˆAè‚¡ / æ¸¯è‚¡ / ç¾è‚¡ï¼‰
         */
        function renderMarketPie(totalAssets) {
            const marketTotals = { 'Aè‚¡': 0, 'æ¸¯è‚¡': 0, 'ç¾è‚¡': 0 };
            holdings.forEach(h => {
                const m = getMarket(h);
                if (marketTotals[m] !== undefined) marketTotals[m] += h.value;
            });
            const totalMarket = marketTotals['Aè‚¡'] + marketTotals['æ¸¯è‚¡'] + marketTotals['ç¾è‚¡'];
            const cash = getTotalCash();
            const total = totalMarket + cash;
            const pctA = total > 0 ? (marketTotals['Aè‚¡'] / total * 100) : 0;
            const pctH = total > 0 ? (marketTotals['æ¸¯è‚¡'] / total * 100) : 0;
            const pctU = total > 0 ? (marketTotals['ç¾è‚¡'] / total * 100) : 0;
            const colors = { 'Aè‚¡': '#22c55e', 'æ¸¯è‚¡': '#3b82f6', 'ç¾è‚¡': '#f59e0b' };
            let conic = '';
            let acc = 0;
            [['Aè‚¡', pctA], ['æ¸¯è‚¡', pctH], ['ç¾è‚¡', pctU]].forEach(([name, p]) => {
                if (p > 0) { conic += `${colors[name]} ${acc}% ${acc + p}%, `; acc += p; }
            });
            conic = conic ? conic.slice(0, -2) : '#e2e8f0 0% 100%';
            const html = `
                <div class="market-pie-chart" style="background: conic-gradient(${conic});"></div>
                <div class="market-pie-legend">
                    <span><i class="dot" style="background:#22c55e;"></i> Aè‚¡ï¼š${marketTotals['Aè‚¡'].toFixed(2)}ä¸‡ (${pctA.toFixed(1)}%)</span>
                    <span><i class="dot" style="background:#3b82f6;"></i> æ¸¯è‚¡ï¼š${marketTotals['æ¸¯è‚¡'].toFixed(2)}ä¸‡ (${pctH.toFixed(1)}%)</span>
                    <span><i class="dot" style="background:#f59e0b;"></i> ç¾è‚¡ï¼š${marketTotals['ç¾è‚¡'].toFixed(2)}ä¸‡ (${pctU.toFixed(1)}%)</span>
                </div>
            `;
            document.getElementById('marketPieWrap').innerHTML = html;
        }

        /**
         * æ¸²æŸ“è¡Œä¸šå æ¯”åˆ†æ
         * åŒ…æ‹¬æŸ±çŠ¶å›¾å’Œæ˜ç»†è¡¨æ ¼ï¼›è¡Œä¸šæ¡ä½¿ç”¨ç»Ÿä¸€æ·±è‰²é…è‰²ï¼Œæ›´é†’ç›®
         * @param {number} totalAssets - æ€»èµ„äº§ï¼ˆä¸‡å…ƒï¼‰
         */
        function renderIndustry(totalAssets) {
            const indMap = {};
            holdings.forEach(h => {
                if (!indMap[h.category]) indMap[h.category] = 0;
                indMap[h.category] += h.value;
            });
            indMap['ç°é‡‘'] = getTotalCash();
            const sorted = Object.entries(indMap).sort((a, b) => b[1] - a[1]);
            
            let barsHtml = '';
            sorted.forEach(([ind, val], idx) => {
                const pct = totalAssets > 0 ? (val / totalAssets * 100) : 0;
                const bg = ind === 'ç°é‡‘' ? 'linear-gradient(90deg, #94a3b8, #64748b)' : INDUSTRY_PALETTE[idx % INDUSTRY_PALETTE.length];
                barsHtml += `
                    <div class="industry-bar">
                        <div class="label">
                            <span>${ind}</span>
                            <span>${val.toFixed(2)}ä¸‡ (${pct.toFixed(2)}%)</span>
                        </div>
                        <div class="bar">
                            <div class="fill" style="width:${pct}%; background:${bg};">
                                ${pct > 5 ? pct.toFixed(1) + '%' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('industryBars').innerHTML = barsHtml;
            
            // ===== æ¸²æŸ“æ˜ç»†è¡¨æ ¼ =====
            let tableHtml = '<table><tr><th>è¡Œä¸šåˆ†ç±»</th><th>å¸‚å€¼(ä¸‡äººæ°‘å¸)</th><th>å æ¯”</th></tr>';
            
            sorted.forEach(([ind, val]) => {
                const pct = totalAssets > 0 ? (val / totalAssets * 100) : 0;
                const tagClass = ind === 'ç°é‡‘' ? '' : 'cat-' + ind;
                
                tableHtml += `
                    <tr>
                        <td><span class="cat-tag ${tagClass}">${ind}</span></td>
                        <td>${val.toFixed(2)}</td>
                        <td>${pct.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            // æ·»åŠ åˆè®¡è¡Œ
            tableHtml += `
                <tr style="font-weight:bold;background:#f7fafc;">
                    <td>åˆè®¡</td>
                    <td>${totalAssets.toFixed(2)}</td>
                    <td>100%</td>
                </tr>
            </table>`;
            
            document.getElementById('industryTable').innerHTML = tableHtml;
        }

        /**
         * åˆ‡æ¢äº§å“æ ‡ç­¾é¡µ
         * @param {string} tab - ç›®æ ‡æ ‡ç­¾é¡µï¼ˆ'1å·', '2å·', '5å·', '6å·', 'all'ï¼‰
         */
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderTable();
        }

        /**
         * ç”¨æˆ·ä¿®æ”¹è¡Œä¸šåˆ†ç±»åï¼šåŒæ­¥åˆ° holdingsã€å†™å…¥é¢„è®¾å¹¶åˆ·æ–°
         */
        function onCategoryChange(inputEl) {
            const stock = inputEl.getAttribute('data-stock');
            const newCat = (inputEl.value || '').trim();
            holdings.filter(h => h.stock === stock).forEach(h => { h.category = newCat || h.category; });
            const one = holdings.find(h => h.stock === stock);
            if (one) setStoredStockPreset(stock, { category: newCat || one.category, market: getMarket(one) });
            calculate();
        }

        /**
         * ç”¨æˆ·ä¿®æ”¹å¸‚åœºåï¼šåŒæ­¥åˆ° holdingsã€å†™å…¥é¢„è®¾å¹¶åˆ·æ–°
         */
        function onMarketChange(selectEl) {
            const stock = selectEl.getAttribute('data-stock');
            const newMarket = (selectEl.value || '').trim();
            if (!newMarket) return;
            holdings.filter(h => h.stock === stock).forEach(h => { h.marketOverride = newMarket; });
            const one = holdings.find(h => h.stock === stock);
            if (one) setStoredStockPreset(stock, { market: newMarket, category: one.category });
            calculate();
        }

        /**
         * æ¸²æŸ“æŒä»“æ˜ç»†è¡¨æ ¼
         * å¸‚åœºä¸ºå¯ç¼–è¾‘ä¸‹æ‹‰ï¼ˆAè‚¡/æ¸¯è‚¡/ç¾è‚¡ï¼‰ï¼›è¡Œä¸šåˆ†ç±»ä¸ºå¯ç¼–è¾‘è¾“å…¥æ¡†ï¼›ä¿®æ”¹ä¼šå†™å…¥é¢„è®¾ä¾›ä¸‹æ¬¡è‡ªåŠ¨åº”ç”¨
         */
        function renderTable() {
            let filtered = currentTab === 'all' 
                ? [...holdings] 
                : holdings.filter(h => h.product === currentTab);
            
            if (currentTab === 'all') {
                const merged = {};
                filtered.forEach(h => {
                    if (!merged[h.stock]) {
                        merged[h.stock] = { stock: h.stock, value: 0, category: h.category, exchange: h.exchange, marketOverride: h.marketOverride };
                    }
                    merged[h.stock].value += h.value;
                });
                filtered = Object.values(merged);
            }
            
            const cash = currentTab === 'all' ? getTotalCash() : getCash(currentTab);
            const totalMarket = filtered.reduce((sum, h) => sum + h.value, 0);
            const totalAsset = totalMarket + cash;
            
            const escapeAttr = (s) => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            
            let html = '<table><tr><th>è‚¡ç¥¨åç§°</th><th>å¸‚å€¼(ä¸‡äººæ°‘å¸)</th><th>å æ¯”</th><th>å¸‚åœº</th><th>è¡Œä¸šåˆ†ç±»</th></tr>';
            
            const marketOptions = ['Aè‚¡', 'æ¸¯è‚¡', 'ç¾è‚¡'];
            filtered.sort((a, b) => b.value - a.value).forEach(h => {
                const pct = totalAsset > 0 ? (h.value / totalAsset * 100).toFixed(2) : 0;
                const market = getMarket(h);
                const selHtml = marketOptions.map(m => `<option value="${escapeAttr(m)}"${m === market ? ' selected' : ''}>${escapeAttr(m)}</option>`).join('');
                const sel = `<select class="market-select" data-stock="${escapeAttr(h.stock)}" onchange="onMarketChange(this)">${selHtml}</select>`;
                html += `
                    <tr>
                        <td>${escapeAttr(h.stock)}</td>
                        <td>${h.value.toFixed(2)}</td>
                        <td>${pct}%</td>
                        <td>${sel}</td>
                        <td><input type="text" class="category-input" value="${escapeAttr(h.category)}" data-stock="${escapeAttr(h.stock)}" onchange="onCategoryChange(this)" placeholder="å¯ä¿®æ”¹" /></td>
                    </tr>
                `;
            });
            
            html += `
                <tr style="background:#ebf8ff;">
                    <td>ç°é‡‘</td>
                    <td>${cash.toFixed(2)}</td>
                    <td>${totalAsset > 0 ? (cash / totalAsset * 100).toFixed(2) : 0}%</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr style="font-weight:bold;background:#f0fff4;">
                    <td>åˆè®¡</td>
                    <td>${totalAsset.toFixed(2)}</td>
                    <td>100%</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            </table>`;
            
            document.getElementById('holdingsTable').innerHTML = html;
        }

        /**
         * æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨çŠ¶æ€
         * æ ¹æ®å½“å‰è¿›åº¦é«˜äº®å¯¹åº”æ­¥éª¤
         */
        function updateSteps() {
            const hasImg = screenshotImages.length > 0;
            const hasData = holdings.length > 0;
            
            // è®¾ç½®å„æ­¥éª¤çš„çŠ¶æ€
            document.getElementById('step1').className = 'step' + (hasImg ? ' completed' : ' active');
            document.getElementById('step2').className = 'step' + (hasData ? ' completed' : (hasImg ? ' active' : ''));
            document.getElementById('step3').className = 'step' + (hasData ? ' active' : '');
        }

        // ================================================================
        // CSV å¯¼å…¥åŠŸèƒ½
        // ================================================================
        
        /**
         * è§¦å‘CSVæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
         */
        function importCSV() { 
            document.getElementById('csvInput').click(); 
        }
        
        /**
         * å¤„ç†CSVæ–‡ä»¶å¯¼å…¥
         * CSVæ ¼å¼è¦æ±‚ï¼šäº§å“,è‚¡ç¥¨åç§°,å¸‚å€¼(ä¸‡å…ƒ),æ•°é‡,è¡Œä¸šåˆ†ç±»
         * @param {Event} e - æ–‡ä»¶è¾“å…¥äº‹ä»¶
         */
        function handleCSV(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(ev) {
                // æŒ‰è¡Œåˆ†å‰²CSVå†…å®¹
                const lines = ev.target.result.split('\n');
                
                // æ¸…ç©ºç°æœ‰æ•°æ®
                holdings = [];
                
                // ä»ç¬¬2è¡Œå¼€å§‹è§£æï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    
                    // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                    if (cols.length >= 3 && cols[0] && cols[1] && parseFloat(cols[2])) {
                        const product = cols[0].trim();       // äº§å“ç¼–å·
                        const stock = cols[1].trim();         // è‚¡ç¥¨åç§°
                        const value = parseFloat(cols[2]);    // å¸‚å€¼
                        
                        const preset = getStoredStockPreset(stock);
                        let category = (preset && preset.category) ? preset.category : (cols.length > 4 ? cols[4].trim() : (categoryMap[stock] || 'Aè‚¡èµ„æº'));
                        const marketOverride = (preset && preset.market) ? preset.market : undefined;
                        if (stock !== 'ç°é‡‘' && !stock.includes('åˆè®¡')) {
                            holdings.push({ product, stock, value, category, marketOverride });
                        }
                    }
                }
                
                // é‡æ–°è®¡ç®—å¹¶æ¸²æŸ“
                calculate();
                alert('å¯¼å…¥æˆåŠŸï¼å…± ' + holdings.length + ' æ¡è®°å½•');
            };
            
            // ä»¥UTF-8ç¼–ç è¯»å–æ–‡ä»¶
            reader.readAsText(file, 'UTF-8');
        }

        // ================================================================
        // Excel å¯¼å‡ºåŠŸèƒ½
        // ================================================================
        
        /**
         * å¯¼å‡ºæ•°æ®åˆ° Excel æ–‡ä»¶
         * ä½¿ç”¨ SheetJS åº“ç”Ÿæˆ xlsx æ ¼å¼æ–‡ä»¶
         */
        function exportExcel() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (holdings.length === 0) { 
                alert('è¯·å…ˆå¯¼å…¥æ•°æ®'); 
                return; 
            }
            
            const data = [];
            
            // ===== æŒ‰äº§å“åˆ†ç»„å¯¼å‡º =====
            ['1å·', '2å·', '5å·', '6å·'].forEach(p => {
                const filtered = holdings.filter(h => h.product === p);
                if (filtered.length === 0) return;
                
                const cash = getCash(p);
                const total = filtered.reduce((s, h) => s + h.value, 0) + cash;
                
                // æ·»åŠ æŒä»“è®°å½•ï¼ˆæŒ‰å¸‚å€¼é™åºï¼‰
                filtered.sort((a, b) => b.value - a.value).forEach(h => {
                    data.push({
                        'äº§å“': p, 
                        'è‚¡ç¥¨åç§°': h.stock, 
                        'å¸‚å€¼(ä¸‡å…ƒäººæ°‘å¸)': h.value, 
                        'å æ¯”': (h.value / total * 100).toFixed(2) + '%', 
                        'è¡Œä¸šåˆ†ç±»': h.category
                    });
                });
                
                // æ·»åŠ ç°é‡‘è¡Œ
                data.push({
                    'äº§å“': p, 
                    'è‚¡ç¥¨åç§°': 'ç°é‡‘', 
                    'å¸‚å€¼(ä¸‡å…ƒäººæ°‘å¸)': cash, 
                    'å æ¯”': (cash / total * 100).toFixed(2) + '%', 
                    'è¡Œä¸šåˆ†ç±»': '-'
                });
                
                // æ·»åŠ åˆè®¡è¡Œ
                data.push({
                    'äº§å“': p, 
                    'è‚¡ç¥¨åç§°': 'ã€åˆè®¡ã€‘', 
                    'å¸‚å€¼(ä¸‡å…ƒäººæ°‘å¸)': total, 
                    'å æ¯”': '100%', 
                    'è¡Œä¸šåˆ†ç±»': '-'
                });
                
                // æ·»åŠ ç©ºè¡Œåˆ†éš”
                data.push({
                    'äº§å“': '', 
                    'è‚¡ç¥¨åç§°': '', 
                    'å¸‚å€¼(ä¸‡å…ƒäººæ°‘å¸)': '', 
                    'å æ¯”': '', 
                    'è¡Œä¸šåˆ†ç±»': ''
                });
            });
            
            // ===== æ·»åŠ è¡Œä¸šæ±‡æ€» =====
            data.push({
                'äº§å“': 'ã€è¡Œä¸šæ±‡æ€»ã€‘', 
                'è‚¡ç¥¨åç§°': '', 
                'å¸‚å€¼(ä¸‡å…ƒäººæ°‘å¸)': '', 
                'å æ¯”': '', 
                'è¡Œä¸šåˆ†ç±»': ''
            });
            
            const totalAssets = holdings.reduce((s, h) => s + h.value, 0) + getTotalCash();
            
            // æŒ‰è¡Œä¸šæ±‡æ€»
            const indMap = {};
            holdings.forEach(h => { 
                indMap[h.category] = (indMap[h.category] || 0) + h.value; 
            });
            indMap['ç°é‡‘'] = getTotalCash();
            
            // æŒ‰å¸‚å€¼é™åºè¾“å‡º
            Object.entries(indMap).sort((a, b) => b[1] - a[1]).forEach(([ind, val]) => {
                data.push({
                    'äº§å“': '', 
                    'è‚¡ç¥¨åç§°': ind, 
                    'å¸‚å€¼(ä¸‡å…ƒäººæ°‘å¸)': val, 
                    'å æ¯”': (val / totalAssets * 100).toFixed(2) + '%', 
                    'è¡Œä¸šåˆ†ç±»': ''
                });
            });
            
            // ===== ä½¿ç”¨ SheetJS ç”Ÿæˆ Excel æ–‡ä»¶ =====
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æŒä»“æ±‡æ€»');
            
            // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¥æœŸï¼‰
            const fileName = `æŒä»“æ±‡æ€»_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('ExcelæŠ¥è¡¨å·²å¯¼å‡ºï¼');
        }

        // ================================================================
        // äº‹ä»¶ç›‘å¬å™¨
        // ================================================================
        
        // ESC é”®å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
        document.addEventListener('keydown', e => { 
            if (e.key === 'Escape') closeViewer(); 
        });
        
        // ================================================================
        // é¡µé¢åˆå§‹åŒ–
        // ================================================================
        toggleOcrKeyBlocks();
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹è®¡ç®—
        calculate();
    </script>
</body>
</html>
